<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>게임 게시판</title>
<style>
  body { max-width: 900px; margin: auto; font-family: Arial, sans-serif; }
  header { margin: 20px 0; display: flex; justify-content: space-between; align-items: center; }
  nav button { margin-left: 10px; }
  #posts { margin-top: 20px; }
  .post { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  #post-detail { display: none; border: 1px solid #999; padding: 15px; margin-top: 20px; }
  form { margin-top: 20px; }
  textarea { width: 100%; height: 80px; }
  input[type=text], input[type=password], select { width: 100%; padding: 8px; margin: 5px 0; }
  img { max-width: 100%; height: auto; margin-top: 10px; }
  #modal { 
    display:none; 
    position:fixed; 
    top:20%; 
    left:50%; 
    transform:translateX(-50%);
    background:#fff; 
    padding:20px; 
    box-shadow:0 0 10px rgba(0,0,0,0.3); 
    z-index: 1000;
  }
  #modal-overlay {
    display:none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    z-index: 999;
  }
</style>
</head>
<body>

<header>
  <h1>게임 게시판</h1>
  <nav>
    <span id="user-info"></span>
    <button id="btn-login">로그인</button>
    <button id="btn-register">회원가입</button>
    <button id="btn-logout" style="display:none;">로그아웃</button>
  </nav>
</header>

<section id="main-section">
  <div id="posts"></div>
  <button id="btn-new-post" style="display:none;">새 글 작성</button>
</section>

<section id="post-detail">
  <button id="btn-back">목록으로</button>
  <h2 id="detail-title"></h2>
  <p id="detail-author"></p>
  <p id="detail-category"></p>
  <img id="detail-image" alt="" style="display:none;" />
  <p id="detail-content"></p>
  <div id="comments"></div>

  <form id="comment-form" style="display:none;">
    <textarea id="comment-content" placeholder="댓글 작성"></textarea>
    <button type="submit">댓글 달기</button>
  </form>
</section>

<div id="modal-overlay"></div>

<!-- 로그인/회원가입 모달 -->
<div id="modal">
  <h3 id="modal-title"></h3>
  <form id="modal-form">
    <input type="text" id="modal-username" placeholder="아이디" required /><br/>
    <input type="password" id="modal-password" placeholder="비밀번호" required /><br/>
    <input type="text" id="modal-nickname" placeholder="닉네임" style="display:none;" required /><br/>
    <button type="submit">제출</button>
    <button type="button" id="modal-cancel">취소</button>
  </form>
  <p id="modal-message" style="color:red;"></p>
</div>

<script>
const apiBase = '/api';

let token = localStorage.getItem('token');
let currentUser = null;
let currentPostId = null;

function setToken(t) {
  token = t;
  if (t) localStorage.setItem('token', t);
  else localStorage.removeItem('token');
  updateUserInfo();
}

function updateUserInfo() {
  if (token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      currentUser = payload.nickname;
      document.getElementById('user-info').textContent = currentUser + ' 님 환영합니다';
      document.getElementById('btn-login').style.display = 'none';
      document.getElementById('btn-register').style.display = 'none';
      document.getElementById('btn-logout').style.display = 'inline-block';
      document.getElementById('btn-new-post').style.display = 'inline-block';
    } catch {
      setToken(null);
    }
  } else {
    currentUser = null;
    document.getElementById('user-info').textContent = '';
    document.getElementById('btn-login').style.display = 'inline-block';
    document.getElementById('btn-register').style.display = 'inline-block';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('btn-new-post').style.display = 'none';
  }
}

async function apiFetch(url, options = {}) {
  options.headers = options.headers || {};
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(apiBase + url, options);
  if (res.status === 401) {
    alert('인증이 필요합니다. 로그인 해주세요.');
    logout();
    throw new Error('Unauthorized');
  }
  return res.json();
}

async function loadPosts() {
  const posts = await apiFetch('/posts');
  const postsDiv = document.getElementById('posts');
  postsDiv.innerHTML = '';
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<h3><a href="#" data-id="${p.id}">${p.title}</a></h3>
                     <p>작성자: ${p.nickname} | 조회수: ${p.views} | 카테고리: ${p.category || '없음'}</p>`;
    postsDiv.appendChild(div);
  });

  document.querySelectorAll('.post a').forEach(el => {
    el.onclick = e => {
      e.preventDefault();
      showPostDetail(e.target.dataset.id);
    };
  });
}

async function showPostDetail(id) {
  const data = await apiFetch('/posts/' + id);
  currentPostId = id;
  document.getElementById('main-section').style.display = 'none';
  const detail = document.getElementById('post-detail');
  detail.style.display = 'block';
  document.getElementById('detail-title').textContent = data.post.title;
  document.getElementById('detail-author').textContent = '작성자: ' + data.post.nickname;
  document.getElementById('detail-category').textContent = '카테고리: ' + (data.post.category || '없음');
  if (data.post.image_url) {
    const img = document.getElementById('detail-image');
    img.src = data.post.image_url;
    img.style.display = 'block';
  } else {
    document.getElementById('detail-image').style.display = 'none';
  }
  document.getElementById('detail-content').textContent = data.post.content;

  const commentsDiv = document.getElementById('comments');
  commentsDiv.innerHTML = '<h4>댓글</h4>';
  data.comments.forEach(c => {
    const cdiv = document.createElement('div');
    cdiv.style.borderTop = '1px solid #ccc';
    cdiv.style.padding = '5px 0';
    cdiv.textContent = c.nickname + ': ' + c.content;
    commentsDiv.appendChild(cdiv);
  });

  if (token) {
    document.getElementById('comment-form').style.display = 'block';
  } else {
    document.getElementById('comment-form').style.display = 'none';
  }
}

document.getElementById('comment-form').onsubmit = async e => {
  e.preventDefault();
  const content = document.getElementById('comment-content').value.trim();
  if (!content) return alert('댓글 내용을 입력하세요.');
  await apiFetch('/comments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ post_id: currentPostId, content })
  });
  document.getElementById('comment-content').value = '';
  showPostDetail(currentPostId);
};

document.getElementById('btn-back').onclick = () => {
  currentPostId = null;
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('main-section').style.display = 'block';
  loadPosts();
};

const modal = document.getElementById('modal');
const modalOverlay = document.getElementById('modal-overlay');
const modalForm = document.getElementById('modal-form');
const modalTitle = document.getElementById('modal-title');
const modalUsername = document.getElementById('modal-username');
const modalPassword = document.getElementById('modal-password');
const modalNickname = document.getElementById('modal-nickname');
const modalMessage = document.getElementById('modal-message');

let modalMode = 'login';

document.getElementById('btn-login').onclick = () => openModal('login');
document.getElementById('btn-register').onclick = () => openModal('register');
document.getElementById('modal-cancel').onclick = closeModal;
document.getElementById('btn-logout').onclick = () => {
  setToken(null);
  alert('로그아웃 되었습니다.');
  loadPosts();
};

function openModal(mode) {
  modalMode = mode;
  modal.style.display = 'block';
  modalOverlay.style.display = 'block';
  modalTitle.textContent = mode === 'login' ? '로그인' : '회원가입';
  modalMessage.textContent = '';
  modalUsername.value = '';
  modalPassword.value = '';
  if (mode === 'register') {
    modalNickname.style.display = 'block';
    modalNickname.value = '';
  } else {
    modalNickname.style.display = 'none';
  }
}

function closeModal() {
  modal.style.display = 'none';
  modalOverlay.style.display = 'none';
}

modalForm.onsubmit = async e => {
  e.preventDefault();
  const username = modalUsername.value.trim();
  const password = modalPassword.value.trim();
  const nickname = modalNickname.value.trim();

  if (!username || !password || (modalMode === 'register' && !nickname)) {
    modalMessage.textContent = '필드를 모두 입력하세요.';
    return;
  }

  try {
    if (modalMode === 'login') {
      const res = await fetch(apiBase + '/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (res.ok) {
        setToken(data.token);
        closeModal();
        loadPosts();
      } else {
        modalMessage.textContent = data.message;
      }
    } else {
      const res = await fetch(apiBase + '/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password, nickname })
      });
      const data = await res.json();
      if (res.ok) {
        alert('회원가입 성공! 로그인 해주세요.');
        openModal('login');
      } else {
        modalMessage.textContent = data.message;
      }
    }
  } catch {
    modalMessage.textContent = '서버 오류가 발생했습니다.';
  }
};

document.getElementById('btn-new-post').onclick = () => {
  const formHtml = `
    <form id="post-form" enctype="multipart/form-data">
      <h3>새 글 작성</h3>
      <input name="title" placeholder="제목" required /><br/>
      <textarea name="content" placeholder="내용" required></textarea><br/>
      <input name="category" placeholder="카테고리 (선택)" /><br/>
      <input type="file" name="image" accept="image/*" /><br/>
      <button type="submit">등록</button>
      <button type="button" id="post-cancel">취소</button>
    </form>
  `;
  const mainSection = document.getElementById('main-section');
  mainSection.style.display = 'none';
  document.getElementById('post-detail').style.display = 'none';

  const container = document.createElement('div');
  container.id = 'post-create';
  container.innerHTML = formHtml;
  document.body.appendChild(container);

  document.getElementById('post-cancel').onclick = () => {
    container.remove();
    mainSection.style.display = 'block';
  };

  document.getElementById('post-form').onsubmit = async e => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const res = await fetch(apiBase + '/posts', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token },
      body: formData
    });

    if (res.ok) {
      alert('게시글이 등록되었습니다.');
      container.remove();
      mainSection.style.display = 'block';
      loadPosts();
    } else {
      const data = await res.json();
      alert(data.message || '게시글 등록 실패');
    }
  };
};

updateUserInfo();
loadPosts();
</script>

</body>
</html>
