<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Í≤åÏûÑ Í≤åÏãúÌåê</title>
<style>
  :root {
    --primary-color: #2979ff;
    --primary-hover: #0059c1;
    --border-color: #ddd;
    --radius: 12px;
    --shadow-light: 0 4px 8px rgba(0,0,0,0.1);
  }
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background: #f9fafb;
    color: #222;
    max-width: 900px;
    padding: 1rem 1.5rem 4rem;
    margin-left: auto;
    margin-right: auto;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  header h1 {
    font-weight: 700;
    font-size: 1.8rem;
    user-select: none;
  }
  nav {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #user-info {
    font-weight: 600;
    color: var(--primary-color);
    min-width: 140px;
  }
  nav button {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    box-shadow: var(--shadow-light);
    transition: background-color 0.3s, box-shadow 0.3s;
    min-width: 80px;
  }
  nav button:hover {
    background: var(--primary-hover);
    box-shadow: 0 6px 14px rgba(0, 89, 193, 0.7);
  }
  nav button:focus {
    outline: 2px solid var(--primary-hover);
    outline-offset: 2px;
  }
  #search-bar {
    display: flex;
    margin-bottom: 1.5rem;
    gap: 10px;
  }
  #search-input {
    flex-grow: 1;
    padding: 10px 14px;
    border-radius: var(--radius);
    border: 1.5px solid var(--border-color);
    font-size: 1rem;
  }
  #search-input:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  #search-button {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 0 22px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    min-width: 90px;
  }
  #search-button:hover {
    background: var(--primary-hover);
  }
  #posts {
    margin-top: 1rem;
  }
  .post {
    border: 1.5px solid var(--border-color);
    border-radius: var(--radius);
    padding: 18px 16px;
    margin-bottom: 14px;
    background: white;
    cursor: pointer;
    box-shadow: var(--shadow-light);
    transition: box-shadow 0.3s, border-color 0.3s;
  }
  .post:hover, .post:focus {
    border-color: var(--primary-color);
    box-shadow: 0 8px 16px rgba(41,121,255,0.3);
    outline: none;
  }
  .post h3 {
    margin: 0 0 8px 0;
    font-weight: 700;
    font-size: 1.2rem;
  }
  .post p {
    margin: 0;
    font-size: 0.9rem;
    color: #555;
  }
  #post-detail {
    display: none;
    border: 1.5px solid var(--border-color);
    border-radius: var(--radius);
    padding: 24px 26px;
    background: white;
    box-shadow: var(--shadow-light);
    margin-top: 2rem;
  }
  #post-detail h2 {
    margin-top: 0;
    font-weight: 700;
    margin-bottom: 8px;
  }
  #post-detail p {
    margin: 4px 0;
  }
  #post-detail img {
    max-width: 100%;
    border-radius: var(--radius);
    margin: 12px 0 18px 0;
  }
  #comments {
    margin-top: 20px;
  }
  #comments > div {
    border-top: 1px solid var(--border-color);
    padding: 8px 0;
    font-size: 0.9rem;
    color: #444;
  }
  #comment-form {
    margin-top: 18px;
    display: flex;
    flex-direction: column;
  }
  #comment-content {
    width: 100%;
    min-height: 90px;
    padding: 10px 12px;
    border-radius: var(--radius);
    border: 1.5px solid var(--border-color);
    font-size: 1rem;
    resize: vertical;
  }
  #comment-content:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  #comment-form button[type=submit] {
    margin-top: 12px;
    align-self: flex-end;
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 10px 24px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
  }
  #comment-form button[type=submit]:hover {
    background: var(--primary-hover);
  }
  #btn-new-post {
    margin-top: 1.5rem;
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 12px 24px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 700;
    font-size: 1.1rem;
    box-shadow: var(--shadow-light);
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  #btn-new-post:hover {
    background: var(--primary-hover);
    box-shadow: 0 6px 14px rgba(0,89,193,0.7);
  }
  #btn-back {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 8px 20px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 18px;
  }
  #btn-back:hover {
    background: var(--primary-hover);
  }
  #new-post-form {
    display: none;
    border: 1.5px solid var(--border-color);
    border-radius: var(--radius);
    padding: 28px 30px;
    box-shadow: var(--shadow-light);
    background: white;
    max-width: 900px;
    margin: 2rem auto 4rem;
  }
  #new-post-form h2 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.6rem;
    margin-bottom: 24px;
  }
  #new-post-form label {
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
    margin-top: 12px;
  }
  #new-post-form input[type=text],
  #new-post-form select,
  #new-post-form textarea {
    width: 100%;
    padding: 10px 14px;
    border-radius: var(--radius);
    border: 1.5px solid var(--border-color);
    font-size: 1rem;
  }
  #new-post-form input[type=text]:focus,
  #new-post-form select:focus,
  #new-post-form textarea:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  #new-post-form textarea {
    min-height: 120px;
    resize: vertical;
  }
  #new-post-form .btn-group {
    margin-top: 20px;
    display: flex;
    gap: 14px;
    justify-content: flex-end;
  }
  #new-post-form button {
    padding: 10px 26px;
    font-weight: 700;
    font-size: 1rem;
    border-radius: var(--radius);
    cursor: pointer;
    border: none;
    transition: background-color 0.3s;
  }
  #new-post-form button#btn-submit-post {
    background: var(--primary-color);
    color: white;
  }
  #new-post-form button#btn-submit-post:hover {
    background: var(--primary-hover);
  }
  #new-post-form button#btn-cancel-post {
    background: #bbb;
    color: #333;
  }
  #new-post-form button#btn-cancel-post:hover {
    background: #999;
    color: white;
  }

  /* Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ */
  #modal-overlay {
    display:none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.45);
    z-index: 999;
  }
  /* Î™®Îã¨ */
  #modal {
    display:none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px 28px 28px;
    box-shadow: 0 0 25px rgba(0,0,0,0.3);
    border-radius: var(--radius);
    width: 360px;
    max-width: 90vw;
    z-index: 1000;
    color: inherit;
    transition: background-color 0.3s, color 0.3s;
  }
  #modal h3 {
    margin: 0 0 18px 0;
    font-weight: 700;
    font-size: 1.4rem;
  }
  #modal-form input[type=text],
  #modal-form input[type=password] {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 14px;
    border-radius: var(--radius);
    border: 1.5px solid var(--border-color);
    font-size: 1rem;
  }
  #modal-form input[type=text]:focus,
  #modal-form input[type=password]:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  #modal-form button {
    width: 100%;
    padding: 12px 0;
    background: var(--primary-color);
    border: none;
    color: white;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 700;
    font-size: 1.1rem;
    transition: background-color 0.3s;
  }
  #modal-form button:hover {
    background: var(--primary-hover);
  }
  #modal-message {
    color: #d33;
    margin-top: 8px;
    font-size: 0.95rem;
    text-align: center;
    min-height: 20px;
  }
  #modal-close {
    position: absolute;
    top: 12px;
    right: 14px;
    font-size: 24px;
    color: #888;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s;
    background: none;
    border: none;
  }
  #modal-close:hover {
    color: var(--primary-color);
  }
  #switch-register {
    margin-top: 18px;
    text-align: center;
    font-size: 0.95rem;
    color: var(--primary-color);
    cursor: pointer;
    user-select: none;
    font-weight: 600;
  }
  #switch-register:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<header>
  <h1>Í≤åÏûÑ Í≤åÏãúÌåê</h1>
  <nav>
    <span id="user-info"></span>
    <button id="btn-login">Î°úÍ∑∏Ïù∏</button>
    <button id="btn-logout" style="display:none;">Î°úÍ∑∏ÏïÑÏõÉ</button>
    <button id="btn-new-post" style="display:none;">ÏÉà Í∏Ä ÏûëÏÑ±</button>
    <button id="toggle-theme" title="Îã§ÌÅ¨Î™®Îìú/ÎùºÏù¥Ìä∏Î™®Îìú Ï†ÑÌôò">üåì</button>
  </nav>
</header>

<section id="main-section">
  <div id="search-bar">
    <input type="text" id="search-input" placeholder="Ï†úÎ™©, ÎÇ¥Ïö©, ÎãâÎÑ§ÏûÑ Í≤ÄÏÉâ" autocomplete="off" />
    <button id="search-button" aria-label="Í≤ÄÏÉâ">Í≤ÄÏÉâ</button>
  </div>

  <div id="posts" tabindex="0" aria-label="Í≤åÏãúÍ∏Ä Î™©Î°ù"></div>
</section>

<section id="post-detail" tabindex="-1" aria-live="polite" aria-label="Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ ÎÇ¥Ïö©" style="display:none;">
  <button id="btn-back">Î™©Î°ùÏúºÎ°ú</button>
  <h2 id="detail-title"></h2>
  <p id="detail-author"></p>
  <p id="detail-category"></p>
  <img id="detail-image" alt="" style="display:none;" />
  <p id="detail-content"></p>
  <div id="comments"></div>

  <form id="comment-form" style="display:none;" aria-label="ÎåìÍ∏Ä ÏûëÏÑ± Ìèº">
    <textarea id="comment-content" placeholder="ÎåìÍ∏Ä ÏûëÏÑ±" aria-required="true"></textarea>
    <button type="submit">ÎåìÍ∏Ä Îã¨Í∏∞</button>
  </form>
</section>

<section id="new-post-form" aria-label="ÏÉà Í∏Ä ÏûëÏÑ± Ìèº" style="display:none;">
  <h2>ÏÉà Í∏Ä ÏûëÏÑ±</h2>
  <form>
    <label for="post-title">Ï†úÎ™©</label>
    <input type="text" id="post-title" required autocomplete="off" />
    <label for="post-category">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
    <select id="post-category">
      <option value="">ÏÑ†ÌÉùÏïàÌï®</option>
      <option value="RPG">RPG</option>
      <option value="Ïï°ÏÖò">Ïï°ÏÖò</option>
      <option value="Ï†ÑÎûµ">Ï†ÑÎûµ</option>
      <option value="Í∏∞ÌÉÄ">Í∏∞ÌÉÄ</option>
    </select>
    <label for="post-content">ÎÇ¥Ïö©</label>
    <textarea id="post-content" required></textarea>
    <div class="btn-group">
      <button type="submit" id="btn-submit-post">ÏûëÏÑ±</button>
      <button type="button" id="btn-cancel-post">Ï∑®ÏÜå</button>
    </div>
  </form>
</section>

<div id="modal-overlay"></div>

<div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1">
  <button id="modal-close" role="button" aria-label="Îã´Í∏∞" tabindex="0">&times;</button>
  <h3 id="modal-title"></h3>
  <form id="modal-form" novalidate>
    <input type="text" id="modal-username" placeholder="ÏïÑÏù¥Îîî" required autocomplete="username" />
    <input type="password" id="modal-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" required autocomplete="current-password" />
    <input type="text" id="modal-nickname" placeholder="ÎãâÎÑ§ÏûÑ" style="display:none;" required autocomplete="nickname" />
    <button type="submit" id="modal-submit-btn"></button>
  </form>
  <p id="modal-message" role="alert" aria-live="assertive"></p>
  <div id="switch-register">Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? ÌöåÏõêÍ∞ÄÏûÖ</div>
</div>

<script>
const apiBase = '/api';

let token = localStorage.getItem('token');
let currentUser = null;
let currentPostId = null;

function setToken(t) {
  token = t;
  if (t) localStorage.setItem('token', t);
  else localStorage.removeItem('token');
  updateUserInfo();
}

function updateUserInfo() {
  if (token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      currentUser = payload.nickname || 'ÏÇ¨Ïö©Ïûê';
      document.getElementById('user-info').textContent = `${currentUser} Îãò ÌôòÏòÅÌï©ÎãàÎã§`;
      document.getElementById('btn-login').style.display = 'none';
      document.getElementById('btn-logout').style.display = 'inline-block';
      document.getElementById('btn-new-post').style.display = 'inline-block';
    } catch {
      setToken(null);
    }
  } else {
    currentUser = null;
    document.getElementById('user-info').textContent = '';
    document.getElementById('btn-login').style.display = 'inline-block';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('btn-new-post').style.display = 'none';
  }
}

async function apiFetch(url, options = {}) {
  options.headers = options.headers || {};
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(apiBase + url, options);
  if (res.status === 401) {
    alert('Ïù∏Ï¶ùÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.');
    logout();
    throw new Error('Unauthorized');
  }
  return res.json();
}

async function loadPosts(searchTerm = '') {
  const query = searchTerm ? `?search=${encodeURIComponent(searchTerm)}` : '';
  const posts = await apiFetch('/posts' + query);
  const postsDiv = document.getElementById('posts');
  postsDiv.innerHTML = '';
  if(posts.length === 0){
    postsDiv.innerHTML = '<p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
    return;
  }
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.tabIndex = 0;
    div.setAttribute('role', 'button');
    div.setAttribute('aria-pressed', 'false');
    div.setAttribute('aria-label', `Ï†úÎ™©: ${p.title}, ÏûëÏÑ±Ïûê: ${p.nickname}, Ïπ¥ÌÖåÍ≥†Î¶¨: ${p.category}`);
    div.innerHTML = `<h3>${escapeHtml(p.title)}</h3><p>ÏûëÏÑ±Ïûê: ${escapeHtml(p.nickname)} | Ïπ¥ÌÖåÍ≥†Î¶¨: ${escapeHtml(p.category || 'Í∏∞ÌÉÄ')}</p>`;
    div.addEventListener('click', () => showPostDetail(p.id));
    div.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        showPostDetail(p.id);
      }
    });
    postsDiv.appendChild(div);
  });
}

// HTML escape Ìï®Ïàò (XSS Î∞©ÏßÄ)
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, (m) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[m]);
}

async function showPostDetail(postId) {
  currentPostId = postId;
  try {
    const post = await apiFetch(`/posts/${postId}`);
    const detailSection = document.getElementById('post-detail');
    detailSection.style.display = 'block';
    document.getElementById('main-section').style.display = 'none';
    document.getElementById('new-post-form').style.display = 'none';

    document.getElementById('detail-title').textContent = post.title;
    document.getElementById('detail-author').textContent = `ÏûëÏÑ±Ïûê: ${post.nickname}`;
    document.getElementById('detail-category').textContent = `Ïπ¥ÌÖåÍ≥†Î¶¨: ${post.category || 'Í∏∞ÌÉÄ'}`;
    if(post.image){
      const imgEl = document.getElementById('detail-image');
      imgEl.src = post.image;
      imgEl.alt = post.title;
      imgEl.style.display = 'block';
    } else {
      document.getElementById('detail-image').style.display = 'none';
    }
    document.getElementById('detail-content').textContent = post.content;

    loadComments(postId);

    if(token){
      document.getElementById('comment-form').style.display = 'flex';
      document.getElementById('comment-content').value = '';
      document.getElementById('comment-content').focus();
    } else {
      document.getElementById('comment-form').style.display = 'none';
    }

    document.getElementById('btn-back').focus();
  } catch (e) {
    alert('Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
  }
}

async function loadComments(postId) {
  try {
    const comments = await apiFetch(`/posts/${postId}/comments`);
    const commentsDiv = document.getElementById('comments');
    commentsDiv.innerHTML = '<h3>ÎåìÍ∏Ä</h3>';
    if (comments.length === 0) {
      commentsDiv.innerHTML += '<p>ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
      return;
    }
    comments.forEach(c => {
      const div = document.createElement('div');
      div.textContent = `${c.nickname}: ${c.content}`;
      commentsDiv.appendChild(div);
    });
  } catch (e) {
    console.error('ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®', e);
  }
}

document.getElementById('btn-back').addEventListener('click', () => {
  currentPostId = null;
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('main-section').style.display = 'block';
  document.getElementById('new-post-form').style.display = 'none';
  document.getElementById('search-input').focus();
});

document.getElementById('search-button').addEventListener('click', () => {
  const val = document.getElementById('search-input').value.trim();
  loadPosts(val);
});
document.getElementById('search-input').addEventListener('keydown', (e) => {
  if(e.key === 'Enter'){
    e.preventDefault();
    document.getElementById('search-button').click();
  }
});

document.getElementById('btn-login').addEventListener('click', () => {
  showModal('login');
});
document.getElementById('btn-logout').addEventListener('click', () => {
  logout();
});
document.getElementById('btn-new-post').addEventListener('click', () => {
  showNewPostForm();
});

document.getElementById('btn-cancel-post').addEventListener('click', () => {
  hideNewPostForm();
});

document.getElementById('btn-submit-post').addEventListener('click', async (e) => {
  e.preventDefault();
  const title = document.getElementById('post-title').value.trim();
  const category = document.getElementById('post-category').value || 'Í∏∞ÌÉÄ';
  const content = document.getElementById('post-content').value.trim();
  if (!title || !content) {
    alert('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
    return;
  }
  try {
    await apiFetch('/posts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({title, category, content})
    });
    alert('Í∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
    hideNewPostForm();
    loadPosts();
  } catch (e) {
    alert('Í∏Ä Îì±Î°ù Ïã§Ìå®');
  }
});

document.getElementById('comment-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const content = document.getElementById('comment-content').value.trim();
  if(!content){
    alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
    return;
  }
  try {
    await apiFetch(`/posts/${currentPostId}/comments`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({content})
    });
    document.getElementById('comment-content').value = '';
    loadComments(currentPostId);
  } catch (e) {
    alert('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®');
  }
});

function showNewPostForm(){
  document.getElementById('new-post-form').style.display = 'block';
  document.getElementById('main-section').style.display = 'none';
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('post-title').focus();
}

function hideNewPostForm(){
  document.getElementById('new-post-form').style.display = 'none';
  document.getElementById('main-section').style.display = 'block';
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('post-title').value = '';
  document.getElementById('post-category').value = '';
  document.getElementById('post-content').value = '';
  document.getElementById('search-input').focus();
}

function logout(){
  setToken(null);
  alert('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.');
  loadPosts();
}

// Î™®Îã¨ Í¥ÄÎ†®
const modalOverlay = document.getElementById('modal-overlay');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modal-title');
const modalUsername = document.getElementById('modal-username');
const modalPassword = document.getElementById('modal-password');
const modalNickname = document.getElementById('modal-nickname');
const modalSubmitBtn = document.getElementById('modal-submit-btn');
const modalMessage = document.getElementById('modal-message');
const switchRegister = document.getElementById('switch-register');
const modalCloseBtn = document.getElementById('modal-close');

let isRegister = false;

function showModal(mode='login'){
  isRegister = (mode === 'register');
  modalTitle.textContent = isRegister ? 'ÌöåÏõêÍ∞ÄÏûÖ' : 'Î°úÍ∑∏Ïù∏';
  modalSubmitBtn.textContent = isRegister ? 'ÌöåÏõêÍ∞ÄÏûÖ' : 'Î°úÍ∑∏Ïù∏';
  modalNickname.style.display = isRegister ? 'block' : 'none';
  modalNickname.required = isRegister;
  modalMessage.textContent = '';
  modalUsername.value = '';
  modalPassword.value = '';
  modalNickname.value = '';
  modalOverlay.style.display = 'block';
  modal.style.display = 'block';
  modalUsername.focus();
  document.body.style.overflow = 'hidden';
}

function hideModal(){
  modalOverlay.style.display = 'none';
  modal.style.display = 'none';
  modalMessage.textContent = '';
  document.body.style.overflow = '';
}

modalCloseBtn.addEventListener('click', () => {
  hideModal();
});

modalOverlay.addEventListener('click', () => {
  hideModal();
});

switchRegister.addEventListener('click', () => {
  showModal(isRegister ? 'login' : 'register');
});

document.getElementById('modal-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const username = modalUsername.value.trim();
  const password = modalPassword.value.trim();
  const nickname = modalNickname.value.trim();

  if (!username || !password || (isRegister && !nickname)) {
    modalMessage.textContent = 'Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
    return;
  }
  modalMessage.textContent = '';

  try {
    if (isRegister) {
      const res = await fetch(apiBase + '/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password, nickname})
      });
      if (!res.ok) {
        const err = await res.json();
        modalMessage.textContent = err.message || 'ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®';
        return;
      }
      alert('ÌöåÏõêÍ∞ÄÏûÖ ÏÑ±Í≥µ! Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.');
      showModal('login');
    } else {
      const res = await fetch(apiBase + '/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password})
      });
      if (!res.ok) {
        const err = await res.json();
        modalMessage.textContent = err.message || 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®';
        return;
      }
      const data = await res.json();
      setToken(data.token);
      hideModal();
      loadPosts();
    }
  } catch (e) {
    modalMessage.textContent = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
  }
});

// ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
updateUserInfo();
loadPosts();

</script>

</body>
</html>
