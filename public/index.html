<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ï≤¥Î•¥ Í∞§Îü¨Î¶¨</title>
<style>
  /* Í∏∞Î≥∏ Ïä§ÌÉÄÏùº Î∞è ÎùºÏù¥Ìä∏/Îã§ÌÅ¨ Î™®Îìú Î≥ÄÏàò */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0 auto;
    max-width: 480px;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
    min-height: 100vh;
    padding-bottom: 70px;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  body.light {
    --bg-color: #f0f2f7;
    --text-color: #222;
    --primary-color: #3366ff;
    --input-bg: #fff;
    --input-border: #c4c9dd;
    --btn-bg: linear-gradient(135deg, #3366ff, #254eda);
    --btn-hover-bg: linear-gradient(135deg, #254eda, #1e3bb3);
    --modal-bg: #fff;
    --comment-bg: #f8fbff;
    --comment-border: #d5dbed;
  }
  body.dark {
    --bg-color: #12161f;
    --text-color: #eee;
    --primary-color: #5599ff;
    --input-bg: #1f2233;
    --input-border: #394165;
    --btn-bg: linear-gradient(135deg, #5599ff, #3366ff);
    --btn-hover-bg: linear-gradient(135deg, #3366ff, #254eda);
    --modal-bg: #1f2233;
    --comment-bg: #2a2e45;
    --comment-border: #394165;
  }

  header {
    position: relative;
    text-align: center;
    padding: 20px 0 16px;
    border-bottom: 1px solid var(--input-border);
  }
  h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.6rem;
  }

  /* ÌÜ†Í∏Ä Î∞è Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº */
  #toggleThemeBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 6px 12px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
    z-index: 100;
    user-select: none;
  }
  #toggleThemeBtn:hover {
    background: var(--btn-hover-bg);
  }
  #logoutBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 6px 14px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
    z-index: 100;
  }
  #logoutBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î∞ïÏä§ */
  #authBox {
    background: var(--modal-bg);
    margin: 30px 16px;
    padding: 20px 24px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgb(0 0 0 / 0.1);
  }
  #authBox h2 {
    margin-top: 0;
    font-weight: 600;
    font-size: 1.3rem;
    margin-bottom: 16px;
    text-align: center;
  }
  #authBox input[type="text"],
  #authBox input[type="password"] {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 14px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1.05rem;
    outline-offset: 2px;
  }
  #authBox input::placeholder {
    color: #999;
  }
  #authBox button {
    width: 100%;
    padding: 12px 0;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: var(--btn-bg);
    color: white;
    transition: background 0.3s;
  }
  #authBox button:hover {
    background: var(--btn-hover-bg);
  }
  #loginBtn {
    width: auto;
    padding: 8px 20px;
    font-size: 1rem;
    border-radius: 6px;
    margin-top: 6px;
    float: right;
  }
  #authToggleText {
    margin-top: 16px;
    text-align: center;
    font-size: 1rem;
    color: var(--primary-color);
    cursor: pointer;
    user-select: none;
  }
  #authToggleText:hover {
    text-decoration: underline;
  }

  /* Í≤åÏãúÌåê */
  #boardSection {
    margin: 16px;
  }
  #boardSection h2 {
    font-size: 1.4rem;
    margin-bottom: 12px;
  }

  /* Í≤ÄÏÉâÏ∞Ω */
  #searchBox {
    margin-bottom: 16px;
    display: flex;
  }
  #searchInput {
    flex-grow: 1;
    padding: 10px 14px;
    font-size: 1rem;
    border-radius: 8px 0 0 8px;
    border: 1.5px solid var(--input-border);
    border-right: none;
    background: var(--input-bg);
    color: var(--text-color);
    outline-offset: 2px;
  }
  #searchBtn {
    padding: 10px 20px;
    font-weight: 700;
    background: var(--btn-bg);
    color: white;
    border-radius: 0 8px 8px 0;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
  }
  #searchBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* Í≤åÏãúÍ∏Ä Î¶¨Ïä§Ìä∏ */
  #postList {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #postList li {
    padding: 14px 16px;
    border-radius: 12px;
    background: var(--comment-bg);
    border: 1.5px solid var(--comment-border);
    margin-bottom: 14px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.25s, color 0.25s;
    display: flex;
    flex-direction: column;
  }
  #postList li:hover {
    background: var(--primary-color);
    color: white;
  }
  #postList li .title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #postList li .title-row .title {
    font-size: 1.1rem;
  }
  #postList li .title-row .category {
    font-size: 0.85rem;
    font-weight: 500;
    background: var(--primary-color);
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
    user-select: none;
  }
  #postList li .preview {
    margin-top: 6px;
    font-weight: 400;
    font-size: 0.9rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ */
  #postDetail {
    display: none;
    margin-top: 20px;
  }
  #postDetail h3 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.5rem;
  }
  #postDetail .post-meta {
    font-size: 0.85rem;
    color: #777;
    margin-bottom: 14px;
  }
  #postContent {
    white-space: pre-wrap;
    font-size: 1.1rem;
    margin-bottom: 24px;
  }
  #backToListBtn {
    background: transparent;
    border: none;
    color: var(--primary-color);
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 20px;
    font-size: 1rem;
  }
  #backToListBtn:hover {
    text-decoration: underline;
  }

  /* Í≤åÏãúÍ∏Ä ÏûëÏÑ± */
  #writePostSection {
    margin: 16px;
    display: none;
    background: var(--modal-bg);
    padding: 24px 20px;
    border-radius: 12px;
    box-shadow: 0 0 14px rgb(0 0 0 / 0.15);
  }
  #writePostSection label {
    font-weight: 700;
    display: block;
    margin-bottom: 6px;
    font-size: 1rem;
    color: var(--text-color);
  }
  #writePostSection input[type="text"],
  #writePostSection textarea,
  #writePostSection select {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 18px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
    outline-offset: 2px;
    resize: vertical;
  }
  #writePostSection textarea {
    min-height: 140px;
  }
  #writePostSection button {
    padding: 12px 24px;
    font-weight: 700;
    background: var(--btn-bg);
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
    margin-right: 12px;
    font-size: 1.1rem;
  }
  #writePostSection button:hover {
    background: var(--btn-hover-bg);
  }

  /* ÎåìÍ∏Ä ÏÑπÏÖò */
  #commentsSection {
    margin-top: 30px;
  }
  #commentsSection h4 {
    margin-bottom: 12px;
    font-weight: 700;
    font-size: 1.2rem;
  }
  #commentsList {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 280px;
    overflow-y: auto;
  }
  #commentsList li {
    background: var(--comment-bg);
    border: 1px solid var(--comment-border);
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 14px;
  }
  #commentsList li .author {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 8px;
    color: var(--primary-color);
  }
  #commentsList li .content {
    white-space: pre-wrap;
    font-size: 1rem;
  }
  #commentsList li .createdAt {
    font-size: 0.75rem;
    color: #777;
    margin-top: 8px;
  }

  /* ÎåìÍ∏Ä ÏûëÏÑ± Ìèº */
  #commentForm {
    display: flex;
    margin-top: 18px;
  }
  #commentInput {
    flex-grow: 1;
    padding: 12px 16px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px 0 0 8px;
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    outline-offset: 2px;
  }
  #commentSubmitBtn {
    padding: 0 24px;
    background: var(--btn-bg);
    border: none;
    color: white;
    font-weight: 700;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 1rem;
  }
  #commentSubmitBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ÏÉà Í∏Ä ÏûëÏÑ± Î≤ÑÌäº - Ïò§Î•∏Ï™Ω ÌïòÎã® Í≥†Ï†ï */
  #showWritePostBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 14px 28px;
    font-weight: 700;
    font-size: 1.2rem;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 16px rgb(0 0 0 / 0.25);
    transition: background 0.3s, transform 0.15s;
    z-index: 90;
    user-select: none;
  }
  #showWritePostBtn:hover {
    background: var(--btn-hover-bg);
    transform: scale(1.07);
  }
  #showWritePostBtn:active {
    transform: scale(0.95);
  }

  /* Ïò§Î•ò Î©îÏãúÏßÄ */
  .errorMsg {
    color: #e53e3e;
    font-size: 0.9rem;
    margin-bottom: 12px;
    text-align: center;
    min-height: 20px;
  }
</style>
</head>
<body class="light">

<header>
  <h1>Ï≤¥Î•¥ Í∞§Îü¨Î¶¨</h1>
</header>

<button id="toggleThemeBtn" title="ÎùºÏù¥Ìä∏ / Îã§ÌÅ¨ Î™®Îìú Ï†ÑÌôò">üåô</button>
<button id="logoutBtn" style="display:none;">Î°úÍ∑∏ÏïÑÏõÉ</button>

<!-- Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ ÏòÅÏó≠ -->
<div id="authBox">
  <!-- Î°úÍ∑∏Ïù∏ Ìèº -->
  <div id="loginForm">
    <h2>Î°úÍ∑∏Ïù∏</h2>
    <div class="errorMsg" id="loginError"></div>
    <input type="text" id="loginId" placeholder="ÏïÑÏù¥Îîî" autocomplete="username" />
    <input type="password" id="loginPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="current-password" />
    <button id="loginBtn">Î°úÍ∑∏Ïù∏</button>
    <div id="authToggleText">Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? ÌöåÏõêÍ∞ÄÏûÖ</div>
  </div>

  <!-- ÌöåÏõêÍ∞ÄÏûÖ Ìèº -->
  <div id="registerForm" style="display:none;">
    <h2>ÌöåÏõêÍ∞ÄÏûÖ</h2>
    <div class="errorMsg" id="registerError"></div>
    <input type="text" id="registerId" placeholder="ÏïÑÏù¥Îîî" autocomplete="username" />
    <input type="password" id="registerPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" autocomplete="new-password" />
    <input type="text" id="registerNickname" placeholder="ÎãâÎÑ§ÏûÑ" />
    <button id="registerBtn">ÌöåÏõêÍ∞ÄÏûÖ</button>
    <div id="authToggleText">Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî? Î°úÍ∑∏Ïù∏</div>
  </div>
</div>

<!-- Í≤åÏãúÌåê -->
<section id="boardSection" style="display:none;">
  <h2>Í≤åÏãúÌåê</h2>

  <!-- Í≤ÄÏÉâ -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Ï†úÎ™© ÎòêÎäî ÎÇ¥Ïö© Í≤ÄÏÉâ" />
    <button id="searchBtn">Í≤ÄÏÉâ</button>
  </div>

  <ul id="postList"></ul>

  <!-- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ -->
  <div id="postDetail" style="display:none;">
    <button id="backToListBtn">&lt; Î™©Î°ùÏúºÎ°ú</button>
    <h3 id="postTitle"></h3>
    <div class="post-meta">ÏûëÏÑ±Ïûê: <span id="postAuthor"></span> | ÏûëÏÑ±Ïùº: <span id="postDate"></span></div>
    <div id="postContent"></div>

    <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
    <section id="commentsSection">
      <h4>ÎåìÍ∏Ä</h4>
      <ul id="commentsList"></ul>
      <form id="commentForm" style="display:none;">
        <input id="commentInput" placeholder="ÎåìÍ∏Ä ÏûëÏÑ±..." autocomplete="off" />
        <button id="commentSubmitBtn" type="submit">Îì±Î°ù</button>
      </form>
      <div id="commentLoginNotice" style="color:#e53e3e; font-weight:700; margin-top:12px; display:none;">ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.</div>
    </section>
  </div>

  <!-- Í≤åÏãúÍ∏Ä ÏûëÏÑ± ÏÑπÏÖò -->
  <section id="writePostSection" style="display:none;">
    <label for="categorySelect">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
    <select id="categorySelect" required>
      <option value="" disabled selected>Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
      <option value="ÏûêÏú†">ÏûêÏú†</option>
      <option value="ÏßàÎ¨∏">ÏßàÎ¨∏</option>
      <option value="Ï†ïÎ≥¥">Ï†ïÎ≥¥</option>
      <option value="Ïû°Îã¥">Ïû°Îã¥</option>
    </select>

    <label for="newPostTitle">Ï†úÎ™©</label>
    <input type="text" id="newPostTitle" placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required />

    <label for="newPostContent">ÎÇ¥Ïö©</label>
    <textarea id="newPostContent" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required></textarea>

    <button id="submitPostBtn">ÏûëÏÑ±ÌïòÍ∏∞</button>
    <button id="cancelPostBtn">Ï∑®ÏÜå</button>
    <div class="errorMsg" id="postErrorMsg"></div>
  </section>
</section>

<!-- ÏÉà Í∏Ä ÏûëÏÑ± Î≤ÑÌäº -->
<button id="showWritePostBtn" title="ÏÉà Í∏Ä ÏûëÏÑ±" style="display:none;">Í∏ÄÏì∞Í∏∞</button>

<script>
  const API_BASE = 'https://foxbox.r-e.kr';

  // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ (nullÏù¥Î©¥ ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉú)
  let currentUser = null;

  // --- DOM ÏöîÏÜå ---
  const body = document.body;
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authBox = document.getElementById('authBox');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const loginError = document.getElementById('loginError');
  const registerError = document.getElementById('registerError');
  const loginId = document.getElementById('loginId');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const registerId = document.getElementById('registerId');
  const registerPassword = document.getElementById('registerPassword');
  const registerNickname = document.getElementById('registerNickname');
  const registerBtn = document.getElementById('registerBtn');
  const authToggleTexts = document.querySelectorAll('#authToggleText');
  const boardSection = document.getElementById('boardSection');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const postList = document.getElementById('postList');
  const postDetail = document.getElementById('postDetail');
  const backToListBtn = document.getElementById('backToListBtn');
  const postTitle = document.getElementById('postTitle');
  const postAuthor = document.getElementById('postAuthor');
  const postDate = document.getElementById('postDate');
  const postContent = document.getElementById('postContent');
  const commentsList = document.getElementById('commentsList');
  const commentForm = document.getElementById('commentForm');
  const commentInput = document.getElementById('commentInput');
  const commentLoginNotice = document.getElementById('commentLoginNotice');
  const showWritePostBtn = document.getElementById('showWritePostBtn');
  const writePostSection = document.getElementById('writePostSection');
  const categorySelect = document.getElementById('categorySelect');
  const newPostTitle = document.getElementById('newPostTitle');
  const newPostContent = document.getElementById('newPostContent');
  const submitPostBtn = document.getElementById('submitPostBtn');
  const cancelPostBtn = document.getElementById('cancelPostBtn');
  const postErrorMsg = document.getElementById('postErrorMsg');

  // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî Í≤åÏãúÍ∏Ä ID
  let currentPostId = null;

  // --- Îã§ÌÅ¨/ÎùºÏù¥Ìä∏ Î™®Îìú Ï†ÄÏû• & ÌÜ†Í∏Ä ---
  function loadTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') {
      body.classList.remove('light');
      body.classList.add('dark');
      toggleThemeBtn.textContent = '‚òÄÔ∏è';
    } else {
      body.classList.remove('dark');
      body.classList.add('light');
      toggleThemeBtn.textContent = 'üåô';
    }
  }
  toggleThemeBtn.addEventListener('click', () => {
    if (body.classList.contains('light')) {
      body.classList.remove('light');
      body.classList.add('dark');
      toggleThemeBtn.textContent = '‚òÄÔ∏è';
      localStorage.setItem('theme', 'dark');
    } else {
      body.classList.remove('dark');
      body.classList.add('light');
      toggleThemeBtn.textContent = 'üåô';
      localStorage.setItem('theme', 'light');
    }
  });
  loadTheme();

  // --- Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ Ìèº ÌÜ†Í∏Ä ---
  authToggleTexts.forEach(textEl => {
    textEl.addEventListener('click', () => {
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        loginError.textContent = '';
        registerError.textContent = '';
      } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        loginError.textContent = '';
        registerError.textContent = '';
      }
    });
  });

  // --- Î°úÍ∑∏Ïù∏ Ìï®Ïàò ---
  async function login() {
    loginError.textContent = '';
    const id = loginId.value.trim();
    const pw = loginPassword.value;
    if (!id || !pw) {
      loginError.textContent = 'ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: pw })
      });
      if (!res.ok) throw new Error('Î°úÍ∑∏Ïù∏ Ïã§Ìå®');
      const data = await res.json();
      if (data.token) {
        currentUser = { id, nickname: data.nickname || id, token: data.token };
        saveSession();
        updateUIByLoginStatus();
        await loadPosts();
      } else {
        loginError.textContent = 'Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
      }
    } catch (e) {
      loginError.textContent = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      console.error(e);
    }
  }
  loginBtn.addEventListener('click', login);

  // --- ÌöåÏõêÍ∞ÄÏûÖ Ìï®Ïàò ---
  async function register() {
    registerError.textContent = '';
    const id = registerId.value.trim();
    const pw = registerPassword.value;
    const nickname = registerNickname.value.trim();
    if (!id || !pw || !nickname) {
      registerError.textContent = 'Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: pw, nickname })
      });
      if (!res.ok) throw new Error('ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®');
      const data = await res.json();
      if (data.success) {
        alert('ÌöåÏõêÍ∞ÄÏûÖ ÏÑ±Í≥µ! Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.');
        // ÌöåÏõêÍ∞ÄÏûÖ ÌõÑ Î°úÍ∑∏Ïù∏ Ìèº Î≥¥Ïù¥Í∏∞
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        registerError.textContent = '';
      } else {
        registerError.textContent = data.message || 'ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®';
      }
    } catch (e) {
      registerError.textContent = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      console.error(e);
    }
  }
  registerBtn.addEventListener('click', register);

  // --- Î°úÍ∑∏ÏïÑÏõÉ ---
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    clearSession();
    updateUIByLoginStatus();
  });

  // --- ÏÑ∏ÏÖò Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ ---
  function saveSession() {
    if (currentUser) {
      localStorage.setItem('session', JSON.stringify(currentUser));
    }
  }
  function loadSession() {
    const sess = localStorage.getItem('session');
    if (sess) {
      try {
        currentUser = JSON.parse(sess);
        // TODO: Ïó¨Í∏∞ÏÑú ÌÜ†ÌÅ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ API ÏûàÏúºÎ©¥ Ìò∏Ï∂ú Í∂åÏû•
      } catch {
        currentUser = null;
      }
    }
  }
  function clearSession() {
    localStorage.removeItem('session');
  }

  // --- UI ÏóÖÎç∞Ïù¥Ìä∏ ---
  function updateUIByLoginStatus() {
    if (currentUser) {
      authBox.style.display = 'none';
      logoutBtn.style.display = 'block';
      boardSection.style.display = 'block';
      showWritePostBtn.style.display = 'block';
      commentForm.style.display = 'flex';
      commentLoginNotice.style.display = 'none';
      writePostSection.style.display = 'none';
    } else {
      authBox.style.display = 'block';
      logoutBtn.style.display = 'none';
      boardSection.style.display = 'block';
      showWritePostBtn.style.display = 'none';
      commentForm.style.display = 'none';
      commentLoginNotice.style.display = 'block';
      writePostSection.style.display = 'none';
    }
    clearPostDetail();
  }

  // --- Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ ---
  async function loadPosts(searchKeyword = '') {
    postList.innerHTML = 'Î°úÎî© Ï§ë...';
    try {
      const url = new URL(`${API_BASE}/posts`);
      if (searchKeyword) url.searchParams.append('q', searchKeyword);
      const res = await fetch(url);
      if (!res.ok) throw new Error('Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®');
      const posts = await res.json();

      if (!Array.isArray(posts) || posts.length === 0) {
        postList.innerHTML = '<li>Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</li>';
        return;
      }
      postList.innerHTML = '';
      posts.forEach(post => {
        const li = document.createElement('li');
        li.dataset.postId = post.id;
        li.innerHTML = `
          <div class="title-row">
            <span class="title">${escapeHtml(post.title)}</span>
            <span class="category">${escapeHtml(post.category)}</span>
          </div>
          <div class="preview">${escapeHtml(post.content).slice(0, 70)}</div>
        `;
        li.addEventListener('click', () => {
          showPostDetail(post.id);
        });
        postList.appendChild(li);
      });
    } catch (e) {
      postList.innerHTML = '<li>Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</li>';
      console.error(e);
    }
  }

  // --- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏Î≥¥Í∏∞ ---
  async function showPostDetail(postId) {
    try {
      const res = await fetch(`${API_BASE}/posts/${postId}`);
      if (!res.ok) throw new Error('Í≤åÏãúÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®');
      const post = await res.json();

      currentPostId = postId;

      postTitle.textContent = post.title;
      postAuthor.textContent = post.nickname || post.author || 'ÏùµÎ™Ö';
      postDate.textContent = new Date(post.createdAt).toLocaleString();
      postContent.textContent = post.content;

      // ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞
      await loadComments(postId);

      postDetail.style.display = 'block';
      boardSection.querySelector('#postList').style.display = 'none';
      boardSection.querySelector('#searchBox').style.display = 'none';

      // ÎåìÍ∏Ä ÏûëÏÑ± Í∞ÄÎä• Ïó¨Î∂Ä
      if (currentUser) {
        commentForm.style.display = 'flex';
        commentLoginNotice.style.display = 'none';
      } else {
        commentForm.style.display = 'none';
        commentLoginNotice.style.display = 'block';
      }

      // Í∏ÄÏì∞Í∏∞ ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
      writePostSection.style.display = 'none';
      showWritePostBtn.style.display = currentUser ? 'block' : 'none';
    } catch (e) {
      alert('Í≤åÏãúÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      console.error(e);
    }
  }

  // --- ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ ---
  async function loadComments(postId) {
    commentsList.innerHTML = 'ÎåìÍ∏Ä Î∂àÎü¨Ïò§Îäî Ï§ë...';
    try {
      const res = await fetch(`${API_BASE}/posts/${postId}/comments`);
      if (!res.ok) throw new Error('ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®');
      const comments = await res.json();

      if (!Array.isArray(comments) || comments.length === 0) {
        commentsList.innerHTML = '<li>ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</li>';
        return;
      }
      commentsList.innerHTML = '';
      comments.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="author">${escapeHtml(c.nickname || c.author || 'ÏùµÎ™Ö')}</div>
          <div class="content">${escapeHtml(c.content)}</div>
          <div class="createdAt">${new Date(c.createdAt).toLocaleString()}</div>
        `;
        commentsList.appendChild(li);
      });
    } catch (e) {
      commentsList.innerHTML = '<li>ÎåìÍ∏ÄÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</li>';
      console.error(e);
    }
  }

  // --- ÎåìÍ∏Ä ÏûëÏÑ± ---
  commentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
      alert('ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.');
      return;
    }
    const content = commentInput.value.trim();
    if (!content) {
      alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/posts/${currentPostId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentUser.token}`
        },
        body: JSON.stringify({ content })
      });
      if (!res.ok) throw new Error('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®');
      commentInput.value = '';
      await loadComments(currentPostId);
    } catch (e) {
      alert('ÎåìÍ∏Ä ÏûëÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      console.error(e);
    }
  });

  // --- Í≤åÏãúÍ∏Ä ÏûëÏÑ± Î≤ÑÌäº ÌÅ¥Î¶≠ ---
  showWritePostBtn.addEventListener('click', () => {
    if (!currentUser) {
      alert('Í∏Ä ÏûëÏÑ±ÏùÑ ÏúÑÌï¥ Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî.');
      return;
    }
    postDetail.style.display = 'none';
    writePostSection.style.display = 'block';
    showWritePostBtn.style.display = 'none';
    // Ï¥àÍ∏∞Ìôî
    categorySelect.value = '';
    newPostTitle.value = '';
    newPostContent.value = '';
    postErrorMsg.textContent = '';
  });

  // --- Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ï∑®ÏÜå ---
  cancelPostBtn.addEventListener('click', () => {
    writePostSection.style.display = 'none';
    showWritePostBtn.style.display = 'block';
    if (currentPostId) {
      showPostDetail(currentPostId);
    } else {
      clearPostDetail();
    }
  });

  // --- Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ï†úÏ∂ú ---
  submitPostBtn.addEventListener('click', async () => {
    postErrorMsg.textContent = '';
    const category = categorySelect.value;
    const title = newPostTitle.value.trim();
    const content = newPostContent.value.trim();
    if (!category) {
      postErrorMsg.textContent = 'Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.';
      return;
    }
    if (!title) {
      postErrorMsg.textContent = 'Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
      return;
    }
    if (!content) {
      postErrorMsg.textContent = 'ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.';
      return;
    }
    if (!currentUser) {
      postErrorMsg.textContent = 'Î°úÍ∑∏Ïù∏ ÌõÑ ÏûëÏÑ± Í∞ÄÎä•Ìï©ÎãàÎã§.';
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/posts`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentUser.token}`
        },
        body: JSON.stringify({ category, title, content })
      });
      if (!res.ok) throw new Error('Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ïã§Ìå®');
      const data = await res.json();
      alert('Í≤åÏãúÍ∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
      writePostSection.style.display = 'none';
      showWritePostBtn.style.display = 'block';
      await loadPosts();
    } catch (e) {
      postErrorMsg.textContent = 'Í≤åÏãúÍ∏Ä ÏûëÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
      console.error(e);
    }
  });

  // --- Î™©Î°ùÏúºÎ°ú Î≤ÑÌäº ÌÅ¥Î¶≠ ---
  backToListBtn.addEventListener('click', () => {
    clearPostDetail();
  });

  // --- Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ïà®Í∏∞Í≥† Î™©Î°ù Î≥¥Ïó¨Ï£ºÍ∏∞ ---
  function clearPostDetail() {
    postDetail.style.display = 'none';
    boardSection.querySelector('#postList').style.display = 'block';
    boardSection.querySelector('#searchBox').style.display = 'flex';
    currentPostId = null;
  }

  // --- Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠ ---
  searchBtn.addEventListener('click', () => {
    const keyword = searchInput.value.trim();
    loadPosts(keyword);
  });

  // --- ÏóîÌÑ∞ÌÇ§Î°ú Í≤ÄÏÉâ Í∞ÄÎä•ÌïòÍ≤å ---
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      searchBtn.click();
    }
  });

  // --- HTML escape Ìï®Ïàò ---
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      switch(m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // --- ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÑ∏ÏÖò Î∂àÎü¨Ïò§Í∏∞ Î∞è UI Ï¥àÍ∏∞Ìôî ---
  window.addEventListener('load', async () => {
    loadSession();
    updateUIByLoginStatus();
    await loadPosts();
  });
</script>

</body>
</html>
