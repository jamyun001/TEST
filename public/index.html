<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì²´ë¥´ ê°¤ëŸ¬ë¦¬</title>
<style>
  /* ê¸°ë³¸ & ë¦¬ì…‹ */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0 auto;
    max-width: 480px;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
    -webkit-tap-highlight-color: transparent;
    min-height: 100vh;
    padding-bottom: 70px;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  body.light {
    --bg-color: #f0f2f7;
    --text-color: #222;
    --primary-color: #3366ff;
    --input-bg: #fff;
    --input-border: #c4c9dd;
    --btn-bg: linear-gradient(135deg, #3366ff, #254eda);
    --btn-hover-bg: linear-gradient(135deg, #254eda, #1e3bb3);
    --modal-bg: #fff;
    --comment-bg: #f8fbff;
    --comment-border: #d5dbed;
    --header-bg: #e6ebff;
  }
  body.dark {
    --bg-color: #12161f;
    --text-color: #eee;
    --primary-color: #5599ff;
    --input-bg: #1f2233;
    --input-border: #394165;
    --btn-bg: linear-gradient(135deg, #5599ff, #3366ff);
    --btn-hover-bg: linear-gradient(135deg, #3366ff, #254eda);
    --modal-bg: #1f2233;
    --comment-bg: #2a2e45;
    --comment-border: #394165;
    --header-bg: #1e2239;
  }

  /* í—¤ë” */
  header {
    position: sticky;
    top: 0;
    background: var(--header-bg);
    display: flex;
    align-items: center;
    padding: 10px 16px;
    gap: 10px;
    z-index: 150;
    border-bottom: 1px solid var(--input-border);
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5rem;
    flex-grow: 1;
    user-select: none;
  }

  /* ë²„ê±° ë©”ë‰´ ë²„íŠ¼ */
  #burgerMenuBtn {
    width: 30px;
    height: 24px;
    border: none;
    background: transparent;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  #burgerMenuBtn span {
    display: block;
    height: 3px;
    background: var(--primary-color);
    border-radius: 2px;
  }

  /* ë¡œê·¸ì¸ ë²„íŠ¼ (ë²„ê±°ë°” ì˜†) */
  #loginBtn {
    padding: 6px 14px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: var(--btn-bg);
    color: white;
    transition: background 0.3s;
  }
  #loginBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
  #logoutBtn {
    padding: 6px 14px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: var(--btn-bg);
    color: white;
    transition: background 0.3s;
    margin-left: auto;
  }
  #logoutBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ì‚¬ì´ë“œ ë©”ë‰´ */
  #sideMenu {
    position: fixed;
    top: 0;
    left: -240px;
    width: 220px;
    height: 100vh;
    background: var(--modal-bg);
    box-shadow: 2px 0 8px rgb(0 0 0 / 0.15);
    padding: 20px 16px;
    box-sizing: border-box;
    transition: left 0.3s ease;
    z-index: 200;
  }
  #sideMenu.open {
    left: 0;
  }
  #sideMenu ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #sideMenu ul li {
    margin-bottom: 12px;
  }
  #sideMenu ul li button {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    background: var(--btn-bg);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  #sideMenu ul li button:hover {
    background: var(--btn-hover-bg);
  }

  /* ë©”ì¸ ì˜ì—­ */
  main {
    padding: 10px 16px 70px;
  }

  /* ê²€ìƒ‰ì°½ */
  #searchSection {
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
  }
  #searchInput {
    flex-grow: 1;
    padding: 10px 14px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1.5px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-color);
    outline-offset: 2px;
  }
  #searchBtn {
    padding: 10px 16px;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    background: var(--btn-bg);
    color: white;
    cursor: pointer;
    transition: background 0.3s;
  }
  #searchBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ì¹´í…Œê³ ë¦¬ ì„ íƒ */
  #categorySelect {
    width: 100%;
    padding: 8px 12px;
    font-size: 1rem;
    margin-bottom: 14px;
    border-radius: 8px;
    border: 1.5px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text-color);
  }

  /* ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ */
  #postList {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #postList li {
    padding: 12px 16px;
    border-radius: 10px;
    background: var(--comment-bg);
    border: 1.5px solid var(--comment-border);
    margin-bottom: 12px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    flex-direction: column;
    transition: background 0.2s, color 0.2s;
  }
  #postList li:hover {
    background: var(--primary-color);
    color: white;
  }
  #postList li .post-title {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 6px;
  }
  #postList li .post-preview {
    font-weight: 400;
    font-size: 0.9rem;
    color: #666;
  }

  /* ê²Œì‹œê¸€ ìƒì„¸ */
  #postDetail {
    display: none;
    margin-top: 20px;
  }
  #postDetail h3 {
    margin-top: 0;
    font-weight: 700;
  }
  #postDetail .post-meta {
    font-size: 0.85rem;
    color: #777;
    margin-bottom: 12px;
  }
  #postContent {
    white-space: pre-wrap;
    margin-bottom: 20px;
  }
  #backToListBtn {
    background: transparent;
    border: none;
    color: var(--primary-color);
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 20px;
  }
  #backToListBtn:hover {
    text-decoration: underline;
  }

  /* ê²Œì‹œê¸€ ì‘ì„± */
  #writePostSection {
    margin: 16px 0;
    display: none;
    background: var(--modal-bg);
    padding: 16px 20px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgb(0 0 0 / 0.1);
  }
  #writePostSection input[type="text"],
  #writePostSection textarea {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 14px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
    outline-offset: 2px;
    resize: vertical;
  }
  #writePostSection textarea {
    min-height: 120px;
  }
  #writePostSection .btn-group {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  #writePostSection button {
    padding: 12px 24px;
    font-weight: 700;
    background: var(--btn-bg);
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 1rem;
  }
  #writePostSection button:hover {
    background: var(--btn-hover-bg);
  }
  #writePostSection button.cancel-btn {
    background: #aaa;
    color: #222;
  }
  #writePostSection button.cancel-btn:hover {
    background: #888;
  }

  /* ëŒ“ê¸€ ì„¹ì…˜ */
  #commentsSection {
    margin-top: 30px;
  }
  #commentsSection h4 {
    margin-bottom: 12px;
    font-weight: 600;
  }
  #commentsList {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 240px;
    overflow-y: auto;
  }
  #commentsList li {
    background: var(--comment-bg);
    border: 1px solid var(--comment-border);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
  }
  #commentsList li .author {
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 6px;
  }
  #commentsList li .content {
    white-space: pre-wrap;
    font-size: 0.95rem;
  }
  #commentsList li .createdAt {
    font-size: 0.75rem;
    color: #777;
    margin-top: 6px;
  }

  /* ëŒ“ê¸€ ì‘ì„± í¼ */
  #commentForm {
    display: flex;
    margin-top: 14px;
  }
  #commentInput {
    flex-grow: 1;
    padding: 10px 14px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px 0 0 8px;
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    outline-offset: 2px;
  }
  #commentSubmitBtn {
    padding: 0 20px;
    background: var(--btn-bg);
    border: none;
    color: white;
    font-weight: 700;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    transition: background 0.3s;
  }
  #commentSubmitBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ - ì˜¤ë¥¸ìª½ í•˜ë‹¨ ê³ ì • */
  #showWritePostBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 14px 22px;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.2);
    transition: background 0.3s, transform 0.15s;
    z-index: 90;
  }
  #showWritePostBtn:hover {
    background: var(--btn-hover-bg);
    transform: scale(1.05);
  }
  #showWritePostBtn:active {
    transform: scale(0.95);
  }

  /* ì˜¤ë¥˜ ë©”ì‹œì§€ */
  .errorMsg {
    color: #e53e3e;
    font-size: 0.85rem;
    margin-bottom: 8px;
    text-align: center;
  }

</style>
</head>
<body class="light">

<header>
  <button id="burgerMenuBtn" aria-label="ë©”ë‰´ ì—´ê¸°" aria-expanded="false" aria-controls="sideMenu">
    <span></span>
    <span></span>
    <span></span>
  </button>
  <h1>ì²´ë¥´ ê°¤ëŸ¬ë¦¬</h1>
  <button id="loginBtn" style="display:none;">ë¡œê·¸ì¸</button>
  <button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
</header>

<!-- ì‚¬ì´ë“œ ë©”ë‰´ -->
<nav id="sideMenu" aria-hidden="true" tabindex="-1">
  <ul>
    <li><button>ì„ì‹œ ë²„íŠ¼1</button></li>
    <li><button>ì„ì‹œ ë²„íŠ¼2</button></li>
    <li><button>ì„ì‹œ ë²„íŠ¼3</button></li>
  </ul>
</nav>

<main>
  <!-- ê²€ìƒ‰ + ì¹´í…Œê³ ë¦¬ -->
  <section id="searchSection">
    <input id="searchInput" type="search" placeholder="ê²Œì‹œë¬¼ ê²€ìƒ‰" aria-label="ê²Œì‹œë¬¼ ê²€ìƒ‰" />
    <button id="searchBtn" aria-label="ê²€ìƒ‰ ì‹¤í–‰">ê²€ìƒ‰</button>
  </section>

  <select id="categorySelect" aria-label="ì¹´í…Œê³ ë¦¬ ì„ íƒ">
    <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
    <option value="ììœ ">ììœ </option>
    <option value="ê³µì§€">ê³µì§€</option>
    <option value="ì§ˆë¬¸">ì§ˆë¬¸</option>
  </select>

  <!-- ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ -->
  <ul id="postList" aria-live="polite" aria-relevant="additions"></ul>

  <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
  <article id="postDetail" tabindex="-1" aria-label="ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°">
    <button id="backToListBtn">&lt; ëª©ë¡ìœ¼ë¡œ</button>
    <h3 id="postTitle"></h3>
    <div class="post-meta">ì‘ì„±ì: <span id="postAuthor"></span> | ì‘ì„±ì¼: <span id="postDate"></span></div>
    <div id="postContent"></div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section id="commentsSection" aria-label="ëŒ“ê¸€ ì„¹ì…˜">
      <h4>ëŒ“ê¸€</h4>
      <ul id="commentsList"></ul>
      <form id="commentForm">
        <input id="commentInput" placeholder="ëŒ“ê¸€ ì‘ì„±..." autocomplete="off" aria-label="ëŒ“ê¸€ ë‚´ìš© ì…ë ¥" />
        <button id="commentSubmitBtn" type="submit">ë“±ë¡</button>
      </form>
    </section>
  </article>

  <!-- ê²Œì‹œê¸€ ì‘ì„± -->
  <section id="writePostSection" aria-label="ê²Œì‹œê¸€ ì‘ì„±" style="display:none;">
    <input type="text" id="newPostTitle" placeholder="ì œëª©" aria-label="ìƒˆ ê²Œì‹œë¬¼ ì œëª©" />
    <textarea id="newPostContent" placeholder="ë‚´ìš©" aria-label="ìƒˆ ê²Œì‹œë¬¼ ë‚´ìš©"></textarea>
    <select id="newPostCategory" aria-label="ì¹´í…Œê³ ë¦¬ ì„ íƒ">
      <option value="ììœ ">ììœ </option>
      <option value="ê³µì§€">ê³µì§€</option>
      <option value="ì§ˆë¬¸">ì§ˆë¬¸</option>
    </select>
    <div class="btn-group">
      <button id="submitPostBtn">ê¸€ ì‘ì„±</button>
      <button id="cancelPostBtn" class="cancel-btn">ì·¨ì†Œ</button>
    </div>
  </section>
</main>

<!-- ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ -->
<button id="showWritePostBtn" title="ìƒˆ ê¸€ ì‘ì„±">ê¸€ì“°ê¸° âœï¸</button>

<!-- ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ í† ê¸€ -->
<button id="toggleThemeBtn" title="ë¼ì´íŠ¸ / ë‹¤í¬ ëª¨ë“œ ì „í™˜" style="position: fixed; top: 10px; left: 10px; z-index: 110;">ğŸŒ™</button>

<script>
  const SERVER_URL = 'http://foxbox.r-e.kr'; // http ì£¼ì†Œë¡œ ë³€ê²½

  // DOM ìš”ì†Œ
  const body = document.body;
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');

  const burgerMenuBtn = document.getElementById('burgerMenuBtn');
  const sideMenu = document.getElementById('sideMenu');

  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const categorySelect = document.getElementById('categorySelect');

  const postList = document.getElementById('postList');
  const postDetail = document.getElementById('postDetail');
  const postTitle = document.getElementById('postTitle');
  const postAuthor = document.getElementById('postAuthor');
  const postDate = document.getElementById('postDate');
  const postContent = document.getElementById('postContent');
  const backToListBtn = document.getElementById('backToListBtn');

  const commentsList = document.getElementById('commentsList = document.getElementById('commentsList');
const commentForm = document.getElementById('commentForm');
const commentInput = document.getElementById('commentInput');
const commentSubmitBtn = document.getElementById('commentSubmitBtn');

const writePostSection = document.getElementById('writePostSection');
const newPostTitle = document.getElementById('newPostTitle');
const newPostContent = document.getElementById('newPostContent');
const newPostCategory = document.getElementById('newPostCategory');
const submitPostBtn = document.getElementById('submitPostBtn');
const cancelPostBtn = document.getElementById('cancelPostBtn');

const showWritePostBtn = document.getElementById('showWritePostBtn');

let currentUser = null;
let currentPostId = null;
let posts = [];

// ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ ì´ˆê¸° ì„¤ì •
function loadTheme() {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    body.classList.remove('light');
    body.classList.add('dark');
    toggleThemeBtn.textContent = 'â˜€ï¸';
  } else {
    body.classList.remove('dark');
    body.classList.add('light');
    toggleThemeBtn.textContent = 'ğŸŒ™';
  }
}
loadTheme();

toggleThemeBtn.addEventListener('click', () => {
  if (body.classList.contains('light')) {
    body.classList.replace('light', 'dark');
    toggleThemeBtn.textContent = 'â˜€ï¸';
    localStorage.setItem('theme', 'dark');
  } else {
    body.classList.replace('dark', 'light');
    toggleThemeBtn.textContent = 'ğŸŒ™';
    localStorage.setItem('theme', 'light');
  }
});

// ì‚¬ì´ë“œ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°
burgerMenuBtn.addEventListener('click', () => {
  const isOpen = sideMenu.classList.toggle('open');
  burgerMenuBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
  sideMenu.setAttribute('aria-hidden', !isOpen);
  if (isOpen) sideMenu.focus();
});

// ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸
function updateAuthUI() {
  if (currentUser) {
    loginBtn.style.display = 'none';
    logoutBtn.style.display = 'inline-block';
  } else {
    loginBtn.style.display = 'inline-block';
    logoutBtn.style.display = 'none';
  }
}

// ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ í† í° ë¶ˆëŸ¬ì˜¤ê¸° & ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function loadUserFromToken() {
  const token = localStorage.getItem('jwt_token');
  if (!token) {
    currentUser = null;
    updateAuthUI();
    return;
  }
  // ì„œë²„ì— í† í° ê²€ì¦ ìš”ì²­
  fetch(`${SERVER_URL}/api/auth/me`, {
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(res => {
    if (!res.ok) throw new Error('í† í° ê²€ì¦ ì‹¤íŒ¨');
    return res.json();
  })
  .then(data => {
    currentUser = data;
    updateAuthUI();
  })
  .catch(() => {
    currentUser = null;
    localStorage.removeItem('jwt_token');
    updateAuthUI();
  });
}

// ê²Œì‹œê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadPosts() {
  const category = categorySelect.value;
  const keyword = searchInput.value.trim();
  let url = `${SERVER_URL}/api/posts?`;
  if (category) url += `category=${encodeURIComponent(category)}&`;
  if (keyword) url += `search=${encodeURIComponent(keyword)}&`;

  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error('ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      return res.json();
    })
    .then(data => {
      posts = data.posts || [];
      renderPostList();
      showListView();
    })
    .catch(err => {
      alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      console.error(err);
    });
}

// ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderPostList() {
  postList.innerHTML = '';
  if(posts.length === 0) {
    postList.innerHTML = '<li>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }
  posts.forEach(post => {
    const li = document.createElement('li');
    li.tabIndex = 0;
    li.className = 'post-item';
    li.dataset.id = post.id;

    const title = document.createElement('div');
    title.className = 'post-title';
    title.textContent = `[${post.category}] ${post.title}`;

    const preview = document.createElement('div');
    preview.className = 'post-preview';
    preview.textContent = post.content.length > 60 ? post.content.slice(0, 60) + '...' : post.content;

    li.appendChild(title);
    li.appendChild(preview);

    li.addEventListener('click', () => openPostDetail(post.id));
    li.addEventListener('keypress', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openPostDetail(post.id);
      }
    });

    postList.appendChild(li);
  });
}

// ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°
function openPostDetail(id) {
  const post = posts.find(p => p.id === id);
  if (!post) return;
  currentPostId = id;

  postTitle.textContent = `[${post.category}] ${post.title}`;
  postAuthor.textContent = post.author;
  postDate.textContent = new Date(post.createdAt).toLocaleString();
  postContent.textContent = post.content;

  loadComments(id);

  postList.style.display = 'none';
  writePostSection.style.display = 'none';
  postDetail.style.display = 'block';
  commentsSection.style.display = 'block';
  commentForm.style.display = 'flex';

  postDetail.focus();
}

// ê²Œì‹œê¸€ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
backToListBtn.addEventListener('click', () => {
  currentPostId = null;
  postDetail.style.display = 'none';
  commentsSection.style.display = 'none';
  commentForm.style.display = 'none';
  postList.style.display = 'block';
  writePostSection.style.display = 'none';
});

// ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
function loadComments(postId) {
  commentsList.innerHTML = '<li>ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
  fetch(`${SERVER_URL}/api/posts/${postId}/comments`)
    .then(res => {
      if (!res.ok) throw new Error('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      return res.json();
    })
    .then(data => {
      renderComments(data.comments || []);
    })
    .catch(err => {
      commentsList.innerHTML = '<li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>';
      console.error(err);
    });
}

// ëŒ“ê¸€ ë Œë”ë§
function renderComments(comments) {
  commentsList.innerHTML = '';
  if(comments.length === 0) {
    commentsList.innerHTML = '<li>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
    return;
  }
  comments.forEach(c => {
    const li = document.createElement('li');
    const author = document.createElement('div');
    author.className = 'author';
    author.textContent = c.author;

    const content = document.createElement('div');
    content.className = 'content';
    content.textContent = c.content;

    const createdAt = document.createElement('div');
    createdAt.className = 'createdAt';
    createdAt.textContent = new Date(c.createdAt).toLocaleString();

    li.appendChild(author);
    li.appendChild(content);
    li.appendChild(createdAt);
    commentsList.appendChild(li);
  });
}

// ëŒ“ê¸€ ì‘ì„±
commentForm.addEventListener('submit', e => {
  e.preventDefault();
  if (!currentUser) {
    alert('ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    return;
  }
  const content = commentInput.value.trim();
  if (!content) return;
  commentSubmitBtn.disabled = true;
  fetch(`${SERVER_URL}/api/posts/${currentPostId}/comments`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
    },
    body: JSON.stringify({ content })
  })
  .then(res => {
    if (!res.ok) throw new Error('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
    return res.json();
  })
  .then(() => {
    commentInput.value = '';
    loadComments(currentPostId);
  })
  .catch(err => {
    alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  })
  .finally(() => {
    commentSubmitBtn.disabled = false;
  });
});

// ìƒˆ ê¸€ ì‘ì„± UI í† ê¸€
showWritePostBtn.addEventListener('click', () => {
  if (!currentUser) {
    alert('ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    return;
  }
  postList.style.display = 'none';
  postDetail.style.display = 'none';
  commentsSection.style.display = 'none';
  commentForm.style.display = 'none';

  writePostSection.style.display = 'block';
  clearWritePostForm();
});

// ê¸€ ì‘ì„± ì·¨ì†Œ ë²„íŠ¼
cancelPostBtn.addEventListener('click', () => {
  writePostSection.style.display = 'none';
  postList.style.display = 'block';
  clearWritePostForm();
});

function clearWritePostForm() {
  newPostTitle.value = '';
  newPostContent.value = '';
  newPostCategory.value = 'ììœ ';
}

// ê¸€ ì‘ì„± ì œì¶œ
submitPostBtn.addEventListener('click', () => {
  if (!currentUser) {
    alert('ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    return;
  }
  const title = newPostTitle.value.trim();
  const content = newPostContent.value.trim();
  const category = newPostCategory.value;

  if (!title || !content) {
    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  submitPostBtn.disabled = true;
  fetch(`${SERVER_URL}/api/posts`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
    },
    body: JSON.stringify({ title, content, category })
  })
  .then(res => {
    if (!res.ok) throw new Error('ê¸€ ì‘ì„± ì‹¤íŒ¨');
    return res.json();
  })
  .then(() => {
    alert('ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
    writePostSection.style.display = 'none';
    clearWritePostForm();
    loadPosts();
  })
  .catch(err => {
    alert('ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    console.error(err);
  })
  .finally(() => {
    submitPostBtn.disabled = false;
  });
});

// ë¡œê·¸ì¸ ëª¨ë‹¬ ëŒ€ì‹  ê°„ë‹¨í•œ prompt ì´ìš© (ì‹¤ì œ ì„œë¹„ìŠ¤ì‹œ ëª¨ë‹¬ ê¶Œì¥)
loginBtn.addEventListener('click', () => {
  const username = prompt('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (!username) return;
  const password = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
  if (!password) return;

  loginBtn.disabled = true;
  fetch(`${SERVER_URL}/api/auth/login`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ username, password })
  })
  .then(res => {
    if (!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
    return res.json();
  })
  .then(data => {
    localStorage.setItem('jwt_token', data.token);
    loadUserFromToken();
    loadPosts();
  })
  .catch(() => {
    alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
  })
  .finally(() => {
    loginBtn.disabled = false;
  });
});

// ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
logoutBtn.addEventListener('click', () => {
  localStorage.removeItem('jwt_token');
  currentUser = null;
  updateAuthUI();
  loadPosts();
});

// ê²€ìƒ‰ ë° ì¹´í…Œê³ ë¦¬ í•„í„° ì´ë²¤íŠ¸
searchBtn.addEventListener('click', () => {
  loadPosts();
});
searchInput.addEventListener('keydown', e => {
  if(e.key === 'Enter') loadPosts();
});
categorySelect.addEventListener('change', () => {
  loadPosts();
});

// ì´ˆê¸° ë°ì´í„° ë¡œë”©
loadUserFromToken();
loadPosts();

function showListView() {
  postList.style.display = 'block';
  postDetail.style.display = 'none';
  commentsSection.style.display = 'none';
  commentForm.style.display = 'none';
  writePostSection.style.display = 'none';
}
</script>
</body>
</html>
