<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì²´ë¥´ ê°¤ëŸ¬ë¦¬</title>
<style>
  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ ë³€ìˆ˜ */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0 auto;
    max-width: 480px;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
    min-height: 100vh;
    padding-bottom: 70px;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  body.light {
    --bg-color: #f0f2f7;
    --text-color: #222;
    --primary-color: #3366ff;
    --input-bg: #fff;
    --input-border: #c4c9dd;
    --btn-bg: linear-gradient(135deg, #3366ff, #254eda);
    --btn-hover-bg: linear-gradient(135deg, #254eda, #1e3bb3);
    --modal-bg: #fff;
    --comment-bg: #f8fbff;
    --comment-border: #d5dbed;
  }
  body.dark {
    --bg-color: #12161f;
    --text-color: #eee;
    --primary-color: #5599ff;
    --input-bg: #1f2233;
    --input-border: #394165;
    --btn-bg: linear-gradient(135deg, #5599ff, #3366ff);
    --btn-hover-bg: linear-gradient(135deg, #3366ff, #254eda);
    --modal-bg: #1f2233;
    --comment-bg: #2a2e45;
    --comment-border: #394165;
  }

  header {
    position: relative;
    text-align: center;
    padding: 20px 0 16px;
    border-bottom: 1px solid var(--input-border);
  }
  h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.6rem;
  }

  /* í† ê¸€ ë° ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
  #toggleThemeBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 6px 12px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
    z-index: 100;
    user-select: none;
  }
  #toggleThemeBtn:hover {
    background: var(--btn-hover-bg);
  }
  #logoutBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 6px 14px;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.3s;
    z-index: 100;
  }
  #logoutBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ë°•ìŠ¤ */
  #authBox {
    background: var(--modal-bg);
    margin: 30px 16px;
    padding: 20px 24px;
    border-radius: 12px;
    box-shadow: 0 0 12px rgb(0 0 0 / 0.1);
  }
  #authBox h2 {
    margin-top: 0;
    font-weight: 600;
    font-size: 1.3rem;
    margin-bottom: 16px;
    text-align: center;
  }
  #authBox input[type="text"],
  #authBox input[type="password"] {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 14px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1.05rem;
    outline-offset: 2px;
  }
  #authBox input::placeholder {
    color: #999;
  }
  #authBox button {
    width: 100%;
    padding: 12px 0;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    background: var(--btn-bg);
    color: white;
    transition: background 0.3s;
  }
  #authBox button:hover {
    background: var(--btn-hover-bg);
  }
  #loginBtn {
    width: auto;
    padding: 8px 20px;
    font-size: 1rem;
    border-radius: 6px;
    margin-top: 6px;
    float: right;
  }
  #authToggleText {
    margin-top: 16px;
    text-align: center;
    font-size: 1rem;
    color: var(--primary-color);
    cursor: pointer;
    user-select: none;
  }
  #authToggleText:hover {
    text-decoration: underline;
  }

  /* ê²Œì‹œíŒ */
  #boardSection {
    margin: 16px;
  }
  #boardSection h2 {
    font-size: 1.4rem;
    margin-bottom: 12px;
  }

  /* ê²€ìƒ‰ì°½ */
  #searchBox {
    margin-bottom: 16px;
    display: flex;
  }
  #searchInput {
    flex-grow: 1;
    padding: 10px 14px;
    font-size: 1rem;
    border-radius: 8px 0 0 8px;
    border: 1.5px solid var(--input-border);
    border-right: none;
    background: var(--input-bg);
    color: var(--text-color);
    outline-offset: 2px;
  }
  #searchBtn {
    padding: 10px 20px;
    font-weight: 700;
    background: var(--btn-bg);
    color: white;
    border-radius: 0 8px 8px 0;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
  }
  #searchBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ */
  #postList {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #postList li {
    padding: 14px 16px;
    border-radius: 12px;
    background: var(--comment-bg);
    border: 1.5px solid var(--comment-border);
    margin-bottom: 14px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.25s, color 0.25s;
    display: flex;
    flex-direction: column;
  }
  #postList li:hover {
    background: var(--primary-color);
    color: white;
  }
  #postList li .title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #postList li .title-row .title {
    font-size: 1.1rem;
  }
  #postList li .title-row .category {
    font-size: 0.85rem;
    font-weight: 500;
    background: var(--primary-color);
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
    user-select: none;
  }
  #postList li .preview {
    margin-top: 6px;
    font-weight: 400;
    font-size: 0.9rem;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ê²Œì‹œê¸€ ìƒì„¸ */
  #postDetail {
    display: none;
    margin-top: 20px;
  }
  #postDetail h3 {
    margin-top: 0;
    font-weight: 700;
    font-size: 1.5rem;
  }
  #postDetail .post-meta {
    font-size: 0.85rem;
    color: #777;
    margin-bottom: 14px;
  }
  #postContent {
    white-space: pre-wrap;
    font-size: 1.1rem;
    margin-bottom: 24px;
  }
  #backToListBtn {
    background: transparent;
    border: none;
    color: var(--primary-color);
    font-weight: 700;
    cursor: pointer;
    margin-bottom: 20px;
    font-size: 1rem;
  }
  #backToListBtn:hover {
    text-decoration: underline;
  }

  /* ê²Œì‹œê¸€ ì‘ì„± */
  #writePostSection {
    margin: 16px;
    display: none;
    background: var(--modal-bg);
    padding: 24px 20px;
    border-radius: 12px;
    box-shadow: 0 0 14px rgb(0 0 0 / 0.15);
  }
  #writePostSection label {
    font-weight: 700;
    display: block;
    margin-bottom: 6px;
    font-size: 1rem;
    color: var(--text-color);
  }
  #writePostSection input[type="text"],
  #writePostSection textarea,
  #writePostSection select {
    width: 100%;
    padding: 12px 14px;
    margin-bottom: 18px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
    outline-offset: 2px;
    resize: vertical;
  }
  #writePostSection textarea {
    min-height: 140px;
  }
  #writePostSection button {
    padding: 12px 24px;
    font-weight: 700;
    background: var(--btn-bg);
    color: white;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
    margin-right: 12px;
    font-size: 1.1rem;
  }
  #writePostSection button:hover {
    background: var(--btn-hover-bg);
  }

  /* ëŒ“ê¸€ ì„¹ì…˜ */
  #commentsSection {
    margin-top: 30px;
  }
  #commentsSection h4 {
    margin-bottom: 12px;
    font-weight: 700;
    font-size: 1.2rem;
  }
  #commentsList {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 280px;
    overflow-y: auto;
  }
  #commentsList li {
    background: var(--comment-bg);
    border: 1px solid var(--comment-border);
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 14px;
  }
  #commentsList li .author {
    font-weight: 700;
    font-size: 0.95rem;
    margin-bottom: 8px;
    color: var(--primary-color);
  }
  #commentsList li .content {
    white-space: pre-wrap;
    font-size: 1rem;
  }
  #commentsList li .createdAt {
    font-size: 0.75rem;
    color: #777;
    margin-top: 8px;
  }

  /* ëŒ“ê¸€ ì‘ì„± í¼ */
  #commentForm {
    display: flex;
    margin-top: 18px;
  }
  #commentInput {
    flex-grow: 1;
    padding: 12px 16px;
    border: 1.5px solid var(--input-border);
    border-radius: 8px 0 0 8px;
    font-size: 1rem;
    background: var(--input-bg);
    color: var(--text-color);
    outline-offset: 2px;
  }
  #commentSubmitBtn {
    padding: 0 24px;
    background: var(--btn-bg);
    border: none;
    color: white;
    font-weight: 700;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 1rem;
  }
  #commentSubmitBtn:hover {
    background: var(--btn-hover-bg);
  }

  /* ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ - ì˜¤ë¥¸ìª½ í•˜ë‹¨ ê³ ì • */
  #showWritePostBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--btn-bg);
    border: none;
    color: white;
    padding: 14px 28px;
    font-weight: 700;
    font-size: 1.2rem;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 4px 16px rgb(0 0 0 / 0.25);
    transition: background 0.3s, transform 0.15s;
    z-index: 90;
    user-select: none;
  }
  #showWritePostBtn:hover {
    background: var(--btn-hover-bg);
    transform: scale(1.07);
  }
  #showWritePostBtn:active {
    transform: scale(0.95);
  }

  /* ì˜¤ë¥˜ ë©”ì‹œì§€ */
  .errorMsg {
    color: #e53e3e;
    font-size: 0.9rem;
    margin-bottom: 12px;
    text-align: center;
    min-height: 20px;
  }
</style>
</head>
<body class="light">

<header>
  <h1>ì²´ë¥´ ê°¤ëŸ¬ë¦¬</h1>
</header>

<button id="toggleThemeBtn" title="ë¼ì´íŠ¸ / ë‹¤í¬ ëª¨ë“œ ì „í™˜">ğŸŒ™</button>
<button id="logoutBtn" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>

<!-- ë¡œê·¸ì¸ / íšŒì›ê°€ì… ì˜ì—­ -->
<div id="authBox">
  <!-- ë¡œê·¸ì¸ í¼ -->
  <div id="loginForm">
    <h2>ë¡œê·¸ì¸</h2>
    <div class="errorMsg" id="loginError"></div>
    <input type="text" id="loginId" placeholder="ì•„ì´ë””" autocomplete="username" />
    <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
    <button id="loginBtn">ë¡œê·¸ì¸</button>
    <div id="authToggleText">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
  </div>

  <!-- íšŒì›ê°€ì… í¼ -->
  <div id="registerForm" style="display:none;">
    <h2>íšŒì›ê°€ì…</h2>
    <div class="errorMsg" id="registerError"></div>
    <input type="text" id="registerId" placeholder="ì•„ì´ë””" autocomplete="username" />
    <input type="password" id="registerPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password" />
    <input type="text" id="registerNickname" placeholder="ë‹‰ë„¤ì„" />
    <button id="registerBtn">íšŒì›ê°€ì…</button>
    <div id="authToggleText">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸</div>
  </div>
</div>

<!-- ê²Œì‹œíŒ -->
<section id="boardSection" style="display:none;">
  <h2>ê²Œì‹œíŒ</h2>

  <!-- ê²€ìƒ‰ -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰" />
    <button id="searchBtn">ê²€ìƒ‰</button>
  </div>

  <ul id="postList"></ul>

  <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
  <div id="postDetail" style="display:none;">
    <button id="backToListBtn">&lt; ëª©ë¡ìœ¼ë¡œ</button>
    <h3 id="postTitle"></h3>
    <div class="post-meta">ì‘ì„±ì: <span id="postAuthor"></span> | ì‘ì„±ì¼: <span id="postDate"></span></div>
    <div id="postContent"></div>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section id="commentsSection">
      <h4>ëŒ“ê¸€</h4>
      <ul id="commentsList"></ul>
      <form id="commentForm" style="display:none;">
        <input id="commentInput" placeholder="ëŒ“ê¸€ ì‘ì„±..." autocomplete="off" />
        <button id="commentSubmitBtn" type="submit">ë“±ë¡</button>
      </form>
      <div id="commentLoginNotice" style="color:#e53e3e; font-weight:700; margin-top:12px; display:none;">ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</div>
    </section>
  </div>

  <!-- ê²Œì‹œê¸€ ì‘ì„± ì„¹ì…˜ -->
  <section id="writePostSection" style="display:none;">
    <label for="categorySelect">ì¹´í…Œê³ ë¦¬</label>
    <select id="categorySelect" required>
      <option value="" disabled selected>ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ììœ ">ììœ </option>
      <option value="ì§ˆë¬¸">ì§ˆë¬¸</option>
      <option value="ì •ë³´">ì •ë³´</option>
      <option value="ì¡ë‹´">ì¡ë‹´</option>
    </select>

    <label for="newPostTitle">ì œëª©</label>
    <input type="text" id="newPostTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required />

    <label for="newPostContent">ë‚´ìš©</label>
    <textarea id="newPostContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>

    <button id="submitPostBtn">ì‘ì„±í•˜ê¸°</button>
    <button id="cancelPostBtn">ì·¨ì†Œ</button>
    <div class="errorMsg" id="postErrorMsg"></div>
  </section>
</section>

<!-- ìƒˆ ê¸€ ì‘ì„± ë²„íŠ¼ -->
<button id="showWritePostBtn" title="ìƒˆ ê¸€ ì‘ì„±" style="display:none;">ê¸€ì“°ê¸°</button>

<script>
  const API_BASE = 'https://foxbox.r-e.kr';

  // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ (nullì´ë©´ ë¹„ë¡œê·¸ì¸ ìƒíƒœ)
  let currentUser = null;

  // --- DOM ìš”ì†Œ ---
  const body = document.body;
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authBox = document.getElementById('authBox');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const loginError = document.getElementById('loginError');
  const registerError = document.getElementById('registerError');
  const loginId = document.getElementById('loginId');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const registerId = document.getElementById('registerId');
  const registerPassword = document.getElementById('registerPassword');
  const registerNickname = document.getElementById('registerNickname');
  const registerBtn = document.getElementById('registerBtn');
  const authToggleTexts = document.querySelectorAll('#authToggleText');
  const boardSection = document.getElementById('boardSection');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const postList = document.getElementById('postList');
  const postDetail = document.getElementById('postDetail');
  const backToListBtn = document.getElementById('backToListBtn');
  const postTitle = document.getElementById('postTitle');
  const postAuthor = document.getElementById('postAuthor');
  const postDate = document.getElementById('postDate');
  const postContent = document.getElementById('postContent');
  const commentsList = document.getElementById('commentsList');
  const commentForm = document.getElementById('commentForm');
  const commentInput = document.getElementById('commentInput');
  const commentLoginNotice = document.getElementById('commentLoginNotice');
  const showWritePostBtn = document.getElementById('showWritePostBtn');
  const writePostSection = document.getElementById('writePostSection');
  const categorySelect = document.getElementById('categorySelect');
  const newPostTitle = document.getElementById('newPostTitle');
  const newPostContent = document.getElementById('newPostContent');
  const submitPostBtn = document.getElementById('submitPostBtn');
  const cancelPostBtn = document.getElementById('cancelPostBtn');
  const postErrorMsg = document.getElementById('postErrorMsg');

  // í˜„ì¬ ë³´ê³  ìˆëŠ” ê²Œì‹œê¸€ ID
  let currentPostId = null;

  // --- ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ ì €ì¥ & í† ê¸€ ---
  function loadTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') {
      body.classList.remove('light');
      body.classList.add('dark');
      toggleThemeBtn.textContent = 'â˜€ï¸';
    } else {
      body.classList.remove('dark');
      body.classList.add('light');
      toggleThemeBtn.textContent = 'ğŸŒ™';
    }
  }
  toggleThemeBtn.addEventListener('click', () => {
    if (body.classList.contains('light')) {
      body.classList.remove('light');
      body.classList.add('dark');
      toggleThemeBtn.textContent = 'â˜€ï¸';
      localStorage.setItem('theme', 'dark');
    } else {
      body.classList.remove('dark');
      body.classList.add('light');
      toggleThemeBtn.textContent = 'ğŸŒ™';
      localStorage.setItem('theme', 'light');
    }
  });
  loadTheme();

  // --- ë¡œê·¸ì¸ / íšŒì›ê°€ì… í¼ í† ê¸€ ---
  authToggleTexts.forEach(textEl => {
    textEl.addEventListener('click', () => {
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        loginError.textContent = '';
        registerError.textContent = '';
      } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        loginError.textContent = '';
        registerError.textContent = '';
      }
    });
  });

  // --- ë¡œê·¸ì¸ í•¨ìˆ˜ ---
  async function login() {
    loginError.textContent = '';
    const id = loginId.value.trim();
    const pw = loginPassword.value;
    if (!id || !pw) {
      loginError.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: pw })
      });
      if (!res.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
      const data = await res.json();
      if (data.token) {
        currentUser = { id, nickname: data.nickname || id, token: data.token };
        saveSession();
        updateUIByLoginStatus();
        await loadPosts();
      } else {
        loginError.textContent = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      }
    } catch (e) {
      loginError.textContent = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      console.error(e);
    }
  }
  loginBtn.addEventListener('click', login);

  // --- íšŒì›ê°€ì… í•¨ìˆ˜ ---
  async function register() {
    registerError.textContent = '';
    const id = registerId.value.trim();
    const pw = registerPassword.value;
    const nickname = registerNickname.value.trim();
    if (!id || !pw || !nickname) {
      registerError.textContent = 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.';
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password: pw, nickname })
      });
      if (!res.ok) throw new Error('íšŒì›ê°€ì… ì‹¤íŒ¨');
      const data = await res.json();
      if (data.success) {
        alert('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
        // íšŒì›ê°€ì… í›„ ë¡œê·¸ì¸ í¼ ë³´ì´ê¸°
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        registerError.textContent = '';
      } else {
        registerError.textContent = data.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨';
      }
    } catch (e) {
      registerError.textContent = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      console.error(e);
    }
  }
  registerBtn.addEventListener('click', register);

  // --- ë¡œê·¸ì•„ì›ƒ ---
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    clearSession();
    updateUIByLoginStatus();
  });

  // --- ì„¸ì…˜ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ---
  function saveSession() {
    if (currentUser) {
      localStorage.setItem('session', JSON.stringify(currentUser));
    }
  }
  function loadSession() {
    const sess = localStorage.getItem('session');
    if (sess) {
      try {
        currentUser = JSON.parse(sess);
        // TODO: ì—¬ê¸°ì„œ í† í° ìœ íš¨ì„± ê²€ì‚¬ API ìˆìœ¼ë©´ í˜¸ì¶œ ê¶Œì¥
      } catch {
        currentUser = null;
      }
    }
  }
  function clearSession() {
    localStorage.removeItem('session');
  }

  // --- UI ì—…ë°ì´íŠ¸ ---
  function updateUIByLoginStatus() {
    if (currentUser) {
      authBox.style.display = 'none';
      logoutBtn.style.display = 'block';
      boardSection.style.display = 'block';
      showWritePostBtn.style.display = 'block';
      commentForm.style.display = 'flex';
      commentLoginNotice.style.display = 'none';
      writePostSection.style.display = 'none';
    } else {
      authBox.style.display = 'block';
      logoutBtn.style.display = 'none';
      boardSection.style.display = 'block';
      showWritePostBtn.style.display = 'none';
      commentForm.style.display = 'none';
      commentLoginNotice.style.display = 'block';
      writePostSection.style.display = 'none';
    }
    clearPostDetail();
  }

  // --- ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ---
  async function loadPosts(searchKeyword = '') {
    postList.innerHTML = 'ë¡œë”© ì¤‘...';
    try {
      const url = new URL(`${API_BASE}/posts`);
      if (searchKeyword) url.searchParams.append('q', searchKeyword);
      const res = await fetch(url);
      if (!res.ok) throw new Error('ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      const posts = await res.json();

      if (!Array.isArray(posts) || posts.length === 0) {
        postList.innerHTML = '<li>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }
      postList.innerHTML = '';
      posts.forEach(post => {
        const li = document.createElement('li');
        li.dataset.postId = post.id;
        li.innerHTML = `
          <div class="title-row">
            <span class="title">${escapeHtml(post.title)}</span>
            <span class="category">${escapeHtml(post.category)}</span>
          </div>
          <div class="preview">${escapeHtml(post.content).slice(0, 70)}</div>
        `;
        li.addEventListener('click', () => {
          showPostDetail(post.id);
        });
        postList.appendChild(li);
      });
    } catch (e) {
      postList.innerHTML = '<li>ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
      console.error(e);
    }
  }

  // --- ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸° ---
  async function showPostDetail(postId) {
    try {
      const res = await fetch(`${API_BASE}/posts/${postId}`);
      if (!res.ok) throw new Error('ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      const post = await res.json();

      currentPostId = postId;

      postTitle.textContent = post.title;
      postAuthor.textContent = post.nickname || post.author || 'ìµëª…';
      postDate.textContent = new Date(post.createdAt).toLocaleString();
      postContent.textContent = post.content;

      // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      await loadComments(postId);

      postDetail.style.display = 'block';
      boardSection.querySelector('#postList').style.display = 'none';
      boardSection.querySelector('#searchBox').style.display = 'none';

      // ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥ ì—¬ë¶€
      if (currentUser) {
        commentForm.style.display = 'flex';
        commentLoginNotice.style.display = 'none';
      } else {
        commentForm.style.display = 'none';
        commentLoginNotice.style.display = 'block';
      }

      // ê¸€ì“°ê¸° ì˜ì—­ ìˆ¨ê¸°ê¸°
      writePostSection.style.display = 'none';
      showWritePostBtn.style.display = currentUser ? 'block' : 'none';
    } catch (e) {
      alert('ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(e);
    }
  }

  // --- ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ---
  async function loadComments(postId) {
    commentsList.innerHTML = 'ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    try {
      const res = await fetch(`${API_BASE}/posts/${postId}/comments`);
      if (!res.ok) throw new Error('ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
      const comments = await res.json();

      if (!Array.isArray(comments) || comments.length === 0) {
        commentsList.innerHTML = '<li>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }
      commentsList.innerHTML = '';
      comments.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="author">${escapeHtml(c.nickname || c.author || 'ìµëª…')}</div>
          <div class="content">${escapeHtml(c.content)}</div>
          <div class="createdAt">${new Date(c.createdAt).toLocaleString()}</div>
        `;
        commentsList.appendChild(li);
      });
    } catch (e) {
      commentsList.innerHTML = '<li>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
      console.error(e);
    }
  }

  // --- ëŒ“ê¸€ ì‘ì„± ---
  commentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) {
      alert('ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
      return;
    }
    const content = commentInput.value.trim();
    if (!content) {
      alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/posts/${currentPostId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentUser.token}`
        },
        body: JSON.stringify({ content })
      });
      if (!res.ok) throw new Error('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨');
      commentInput.value = '';
      await loadComments(currentPostId);
    } catch (e) {
      alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(e);
    }
  });

  // --- ê²Œì‹œê¸€ ì‘ì„± ë²„íŠ¼ í´ë¦­ ---
  showWritePostBtn.addEventListener('click', () => {
    if (!currentUser) {
      alert('ê¸€ ì‘ì„±ì„ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
      return;
    }
    postDetail.style.display = 'none';
    writePostSection.style.display = 'block';
    showWritePostBtn.style.display = 'none';
    // ì´ˆê¸°í™”
    categorySelect.value = '';
    newPostTitle.value = '';
    newPostContent.value = '';
    postErrorMsg.textContent = '';
  });

  // --- ê²Œì‹œê¸€ ì‘ì„± ì·¨ì†Œ ---
  cancelPostBtn.addEventListener('click', () => {
    writePostSection.style.display = 'none';
    showWritePostBtn.style.display = 'block';
    if (currentPostId) {
      showPostDetail(currentPostId);
    } else {
      clearPostDetail();
    }
  });

  // --- ê²Œì‹œê¸€ ì‘ì„± ì œì¶œ ---
  submitPostBtn.addEventListener('click', async () => {
    postErrorMsg.textContent = '';
    const category = categorySelect.value;
    const title = newPostTitle.value.trim();
    const content = newPostContent.value.trim();
    if (!category) {
      postErrorMsg.textContent = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
      return;
    }
    if (!title) {
      postErrorMsg.textContent = 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.';
      return;
    }
    if (!content) {
      postErrorMsg.textContent = 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.';
      return;
    }
    if (!currentUser) {
      postErrorMsg.textContent = 'ë¡œê·¸ì¸ í›„ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.';
      return;
    }
    try {
      const res = await fetch(`${API_BASE}/posts`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentUser.token}`
        },
        body: JSON.stringify({ category, title, content })
      });
      if (!res.ok) throw new Error('ê²Œì‹œê¸€ ì‘ì„± ì‹¤íŒ¨');
      const data = await res.json();
      alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
      writePostSection.style.display = 'none';
      showWritePostBtn.style.display = 'block';
      await loadPosts();
    } catch (e) {
      postErrorMsg.textContent = 'ê²Œì‹œê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      console.error(e);
    }
  });

  // --- ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ í´ë¦­ ---
  backToListBtn.addEventListener('click', () => {
    clearPostDetail();
  });

  // --- ê²Œì‹œê¸€ ìƒì„¸ ìˆ¨ê¸°ê³  ëª©ë¡ ë³´ì—¬ì£¼ê¸° ---
  function clearPostDetail() {
    postDetail.style.display = 'none';
    boardSection.querySelector('#postList').style.display = 'block';
    boardSection.querySelector('#searchBox').style.display = 'flex';
    currentPostId = null;
  }

  // --- ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ---
  searchBtn.addEventListener('click', () => {
    const keyword = searchInput.value.trim();
    loadPosts(keyword);
  });

  // --- ì—”í„°í‚¤ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•˜ê²Œ ---
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      searchBtn.click();
    }
  });

  // --- HTML escape í•¨ìˆ˜ ---
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      switch(m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return m;
      }
    });
  }

  // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ì…˜ ë¶ˆëŸ¬ì˜¤ê¸° ë° UI ì´ˆê¸°í™” ---
  window.addEventListener('load', async () => {
    loadSession();
    updateUIByLoginStatus();
    await loadPosts();
  });
</script>

</body>
</html>
