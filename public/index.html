<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê²Œì„ ê²Œì‹œíŒ</title>
<style>
  :root {
    --bg-color-light: #f4f4f4;
    --text-color-light: #222;
    --bg-color-dark: #121212;
    --text-color-dark: #eee;
    --primary-color: #2979ff;
    --border-color-light: #ccc;
    --border-color-dark: #444;
  }
  body {
    max-width: 900px;
    margin: auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color-light);
    color: var(--text-color-light);
    transition: background-color 0.3s, color 0.3s;
    padding: 1rem;
  }
  body.dark {
    background-color: var(--bg-color-dark);
    color: var(--text-color-dark);
  }
  header {
    margin: 20px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  nav button, nav #toggle-theme {
    margin-left: 10px;
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  nav button:hover, nav #toggle-theme:hover {
    background: #0059c1;
  }

  /* ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
  #search-bar {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  #search-input {
    flex-grow: 1;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid var(--border-color-light);
    transition: border-color 0.3s;
  }
  #search-input:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  #search-button {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  #search-button:hover {
    background: #0059c1;
  }

  #posts {
    margin-top: 20px;
  }
  .post {
    border: 1px solid var(--border-color-light);
    padding: 18px 20px;
    margin-bottom: 14px;
    border-radius: 12px;
    background: white;
    transition: background-color 0.3s, border-color 0.3s;
    cursor: pointer;
  }
  body.dark .post {
    background: #222;
    border-color: var(--border-color-dark);
  }
  .post h3 {
    margin: 0 0 10px 0;
    font-size: 1.2rem;
  }
  .post h3 a {
    color: var(--primary-color);
    text-decoration: none;
  }
  .post h3 a:hover {
    text-decoration: underline;
  }
  .post-info {
    font-size: 0.9rem;
    color: #666;
    user-select: none;
  }
  body.dark .post-info {
    color: #bbb;
  }

  #post-detail {
    display: none;
    border: 1px solid var(--border-color-light);
    padding: 22px 26px;
    margin-top: 20px;
    border-radius: 12px;
    background: white;
    transition: background-color 0.3s, border-color 0.3s;
  }
  body.dark #post-detail {
    background: #222;
    border-color: var(--border-color-dark);
  }
  #post-detail img {
    max-width: 100%;
    height: auto;
    margin: 14px 0;
    border-radius: 8px;
  }
  #comments > div {
    border-top: 1px solid var(--border-color-light);
    padding: 10px 0;
    font-size: 0.95rem;
  }
  body.dark #comments > div {
    border-color: var(--border-color-dark);
  }
  #comments h4 {
    margin-bottom: 10px;
  }
  form {
    margin-top: 20px;
  }
  textarea, input[type=text], select {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--border-color-light);
    background: white;
    color: inherit;
    font-size: 1rem;
    transition: background-color 0.3s, border-color 0.3s;
    box-sizing: border-box;
  }
  body.dark textarea, body.dark input[type=text], body.dark select {
    background: #333;
    border-color: var(--border-color-dark);
  }
  textarea {
    height: 90px;
    resize: vertical;
  }
  button[type=submit], #btn-new-post, #btn-back {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    margin-top: 14px;
    transition: background-color 0.3s;
  }
  button[type=submit]:hover, #btn-new-post:hover, #btn-back:hover {
    background: #0059c1;
  }
  #btn-new-post {
    margin-top: 24px;
  }

  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  #modal-overlay {
    display:none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    z-index: 999;
  }
  #modal {
    display:none;
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 30px 28px 22px 28px;
    box-shadow: 0 0 18px rgba(0,0,0,0.25);
    border-radius: 14px;
    width: 320px;
    max-width: 90vw;
    z-index: 1000;
    color: inherit;
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark #modal {
    background: #222;
    color: var(--text-color-dark);
  }
  #modal h3 {
    margin: 0 0 18px 0;
    font-weight: 700;
    font-size: 1.4rem;
    text-align: center;
  }
  #modal input[type=text], #modal input[type=password] {
    margin-bottom: 16px;
    font-size: 1rem;
    padding: 10px 12px;
  }
  #modal button {
    width: 100%;
    padding: 12px 0;
    font-weight: 700;
    font-size: 1.1rem;
    border-radius: 14px;
    margin-top: 6px;
  }
  #modal-message {
    color: #d33;
    margin-top: 12px;
    font-size: 0.95rem;
    text-align: center;
    min-height: 1.2em;
  }
  #modal .switch-to-register {
    margin-top: 20px;
    text-align: center;
    font-size: 0.95rem;
    color: var(--primary-color);
    cursor: pointer;
    user-select: none;
  }
  #modal .switch-to-register:hover {
    text-decoration: underline;
  }
  #modal-close {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--primary-color);
    cursor: pointer;
    user-select: none;
  }
  #modal-close:hover {
    color: #0059c1;
  }

  /* ìƒˆ ê¸€ ì‘ì„± í¼ ìŠ¤íƒ€ì¼ */
  #new-post-form {
    display: none;
    margin-top: 20px;
    border: 1px solid var(--border-color-light);
    border-radius: 14px;
    padding: 24px 28px;
    background: white;
    transition: background-color 0.3s, border-color 0.3s;
  }
  body.dark #new-post-form {
    background: #222;
    border-color: var(--border-color-dark);
  }
  #new-post-form label {
    font-weight: 600;
    margin-top: 12px;
    display: block;
    font-size: 1rem;
  }
  #new-post-form select {
    margin-top: 6px;
  }
</style>
</head>
<body>

<header>
  <h1>ê²Œì„ ê²Œì‹œíŒ</h1>
  <nav>
    <span id="user-info"></span>
    <button id="btn-login">ë¡œê·¸ì¸</button>
    <button id="btn-logout" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    <button id="toggle-theme" title="ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ ì „í™˜">ğŸŒ“</button>
  </nav>
</header>

<section id="main-section">

  <div id="search-bar">
    <input type="text" id="search-input" placeholder="ì œëª©, ë‚´ìš©, ë‹‰ë„¤ì„ ê²€ìƒ‰" />
    <button id="search-button">ê²€ìƒ‰</button>
  </div>

  <div id="posts"></div>

  <button id="btn-new-post" style="display:none;">ìƒˆ ê¸€ ì‘ì„±</button>

  <form id="new-post-form">
    <label for="post-title">ì œëª©</label>
    <input type="text" id="post-title" placeholder="ê¸€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required />

    <label for="post-category">ì¹´í…Œê³ ë¦¬</label>
    <select id="post-category">
      <option value="">ì„ íƒì•ˆí•¨</option>
      <option value="RPG">RPG</option>
      <option value="FPS">FPS</option>
      <option value="ì•¡ì…˜">ì•¡ì…˜</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>

    <label for="post-content">ë‚´ìš©</label>
    <textarea id="post-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>

    <button type="submit">ê¸€ ë“±ë¡</button>
    <button type="button" id="btn-cancel-post" style="margin-left: 12px; background: #999;">ì·¨ì†Œ</button>
  </form>
</section>

<section id="post-detail">
  <button id="btn-back">ëª©ë¡ìœ¼ë¡œ</button>
  <h2 id="detail-title"></h2>
  <p id="detail-author"></p>
  <p id="detail-category"></p>
  <img id="detail-image" alt="" style="display:none;" />
  <p id="detail-content"></p>
  <div id="comments"></div>

  <form id="comment-form" style="display:none;">
    <textarea id="comment-content" placeholder="ëŒ“ê¸€ ì‘ì„±"></textarea>
    <button type="submit">ëŒ“ê¸€ ë‹¬ê¸°</button>
  </form>
</section>

<div id="modal-overlay"></div>

<div id="modal">
  <div id="modal-close" title="ë‹«ê¸°">Ã—</div>
  <h3 id="modal-title"></h3>
  <form id="modal-form">
    <input type="text" id="modal-username" placeholder="ì•„ì´ë””" required autocomplete="username" />
    <input type="password" id="modal-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required autocomplete="current-password" />
    <input type="text" id="modal-nickname" placeholder="ë‹‰ë„¤ì„" style="display:none;" required autocomplete="nickname" />
    <button type="submit">ì œì¶œ</button>
  </form>
  <p id="modal-message"></p>
  <div class="switch-to-register" id="switch-register">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
</div>

<script>
const apiBase = '/api';

let token = localStorage.getItem('token');
let currentUser = null;
let currentPostId = null;

function setToken(t) {
  token = t;
  if (t) localStorage.setItem('token', t);
  else localStorage.removeItem('token');
  updateUserInfo();
}

function updateUserInfo() {
  if (token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      currentUser = payload.nickname;
      document.getElementById('user-info').textContent = currentUser + 'ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤';
      document.getElementById('btn-login').style.display = 'none';
      document.getElementById('btn-logout').style.display = 'inline-block';
      document.getElementById('btn-new-post').style.display = 'inline-block';
    } catch {
      setToken(null);
    }
  } else {
    currentUser = null;
    document.getElementById('user-info').textContent = '';
    document.getElementById('btn-login').style.display = 'inline-block';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('btn-new-post').style.display = 'none';
  }
}

async function apiFetch(url, options = {}) {
  options.headers = options.headers || {};
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(apiBase + url, options);
  if (res.status === 401) {
    alert('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
    logout();
    throw new Error('Unauthorized');
  }
  return res.json();
}

async function loadPosts(searchTerm = '') {
  const query = searchTerm ? `?search=${encodeURIComponent(searchTerm)}` : '';
  const posts = await apiFetch('/posts' + query);
  const postsDiv = document.getElementById('posts');
  postsDiv.innerHTML = '';
  if(posts.length === 0){
    postsDiv.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<h3><a href="#" data-id="${p.id}">${escapeHtml(p.title)}</a></h3>
                     <p class="post-info">ì‘ì„±ì: ${escapeHtml(p.nickname)}ë‹˜ | ì¡°íšŒìˆ˜: ${p.views} | ì¹´í…Œê³ ë¦¬: ${escapeHtml(p.category || 'ì—†ìŒ')}</p>`;
    postsDiv.appendChild(div);
  });

  document.querySelectorAll('.post a').forEach(el => {
    el.onclick = e => {
      e.preventDefault();
      showPostDetail(e.target.dataset.id);
    };
  });
}

function escapeHtml(text) {
  if(!text) return '';
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
}

async function showPostDetail(id) {
  const data = await apiFetch('/posts/' + id);
  currentPostId = id;
  document.getElementById('main-section').style.display = 'none';
  document.getElementById('new-post-form').style.display = 'none';
  const detail = document.getElementById('post-detail');
  detail.style.display = 'block';
  document.getElementById('detail-title').textContent = data.post.title;
  document.getElementById('detail-author').textContent = 'ì‘ì„±ì: ' + data.post.nickname + 'ë‹˜';
  document.getElementById('detail-category').textContent = 'ì¹´í…Œê³ ë¦¬: ' + (data.post.category || 'ì—†ìŒ');
  if (data.post.image_url) {
    const img = document.getElementById('detail-image');
    img.src = data.post.image_url;
    img.style.display = 'block';
  } else {
    document.getElementById('detail-image').style.display = 'none';
  }
  document.getElementById('detail-content').textContent = data.post.content;

  const commentsDiv = document.getElementById('comments');
  commentsDiv.innerHTML = '<h4>ëŒ“ê¸€</h4>';
  data.comments.forEach(c => {
    const cdiv = document.createElement('div');
    cdiv.textContent = c.nickname + 'ë‹˜: ' + c.content;
    commentsDiv.appendChild(cdiv);
  });

  if (token) {
    document.getElementById('comment-form').style.display = 'block';
  } else {
    document.getElementById('comment-form').style.display = 'none';
  }
}

document.getElementById('comment-form').onsubmit = async e => {
  e.preventDefault();
  const content = document.getElementById('comment-content').value.trim();
  if (!content) return alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
  await apiFetch('/comments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ post_id: currentPostId, content })
  });
  document.getElementById('comment-content').value = '';
  showPostDetail(currentPostId);
};

document.getElementById('btn-back').onclick = () => {
  currentPostId = null;
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('main-section').style.display = 'block';
  document.getElementById('new-post-form').style.display = 'none';
  loadPosts();
};

const modal = document.getElementById('modal');
const modalOverlay = document.getElementById('modal-overlay');
const modalForm = document.getElementById('modal-form');
const modalTitle = document.getElementById('modal-title');
const modalUsername = document.getElementById('modal-username');
const modalPassword = document.getElementById('modal-password');
const modalNickname = document.getElementById('modal-nickname');
const modalMessage = document.getElementById('modal-message');
const modalClose = document.getElementById('modal-close');

let modalMode = 'login';

document.getElementById('btn-login').onclick = () => openModal('login');
document.getElementById('btn-logout').onclick = () => {
  setToken(null);
  alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
  loadPosts();
};
document.getElementById('btn-new-post').onclick = () => {
  document.getElementById('main-section').style.display = 'none';
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('new-post-form').style.display = 'block';
  clearNewPostForm();
};

document.getElementById('btn-cancel-post').onclick = () => {
  document.getElementById('new-post-form').style.display = 'none';
  document.getElementById('main-section').style.display = 'block';
};

document.getElementById('switch-register').onclick = () => openModal('register');
modalClose.onclick = closeModal;
modalOverlay.onclick = closeModal;

function openModal(mode) {
  modalMode = mode;
  modal.style.display = 'block';
  modalOverlay.style.display = 'block';
  modalTitle.textContent = mode === 'login' ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…';
  modalMessage.textContent = '';
  modalUsername.value = '';
  modalPassword.value = '';
  if (mode === 'register') {
    modalNickname.style.display = 'block';
    modalNickname.value = '';
    document.getElementById('switch-register').textContent = 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸';
  } else {
    modalNickname.style.display = 'none';
    document.getElementById('switch-register').textContent = 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…';
  }
}

function closeModal() {
  modal.style.display = 'none';
  modalOverlay.style.display = 'none';
}

modalForm.onsubmit = async e => {
  e.preventDefault();
  const username = modalUsername.value.trim();
  const password = modalPassword.value.trim();
  const nickname = modalNickname.value.trim();

  if (!username || !password || (modalMode === 'register' && !nickname)) {
    modalMessage.textContent = 'í•„ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.';
    return;
  }

  try {
    if (modalMode === 'login') {
      const res = await fetch(apiBase + '/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (res.ok) {
        setToken(data.token);
        closeModal();
        loadPosts();
      } else {
        modalMessage.textContent = data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
      }
    } else {
      const res = await fetch(apiBase + '/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password, nickname })
      });
      const data = await res.json();
      if (res.ok) {
        alert('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
        openModal('login');
      } else {
        modalMessage.textContent = data.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨';
      }
    }
  } catch {
    modalMessage.textContent = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  }
};

// ë‹¤í¬ëª¨ë“œ í† ê¸€
const themeToggleBtn = document.getElementById('toggle-theme');
function loadTheme() {
  const saved = localStorage.getItem('theme');
  if(saved === 'dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
}
function toggleTheme() {
  document.body.classList.toggle('dark');
  if(document.body.classList.contains('dark')) localStorage.setItem('theme', 'dark');
  else localStorage.setItem('theme', 'light');
}
themeToggleBtn.onclick = toggleTheme;
loadTheme();

// ê²€ìƒ‰ ê¸°ëŠ¥
const searchInput = document.getElementById('search-input');
const searchButton = document.getElementById('search-button');

searchButton.onclick = () => {
  const keyword = searchInput.value.trim();
  loadPosts(keyword);
};

searchInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchButton.click();
  }
});

// ìƒˆ ê¸€ ì‘ì„± í¼ ì œì¶œ ì²˜ë¦¬
document.getElementById('new-post-form').onsubmit = async e => {
  e.preventDefault();
  const title = document.getElementById('post-title').value.trim();
  const category = document.getElementById('post-category').value;
  const content = document.getElementById('post-content').value.trim();

  if (!title || !content) {
    alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  try {
    const res = await apiFetch('/posts', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ title, category, content })
    });
    if (res.id) {
      alert('ê¸€ ì‘ì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      document.getElementById('new-post-form').style.display = 'none';
      document.getElementById('main-section').style.display = 'block';
      clearNewPostForm();
      loadPosts();
    } else {
      alert('ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (err) {
    alert('ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
};

function clearNewPostForm() {
  document.getElementById('post-title').value = '';
  document.getElementById('post-category').value = '';
  document.getElementById('post-content').value = '';
}

updateUserInfo();
loadPosts();
</script>
</body>
</html>
