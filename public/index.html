<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>게임 게시판</title>
<style>
  /* 다크모드/라이트모드 기본 */
  :root {
    --bg-color-light: #f4f4f4;
    --text-color-light: #222;
    --bg-color-dark: #121212;
    --text-color-dark: #eee;
    --primary-color: #2979ff;
    --border-color-light: #ccc;
    --border-color-dark: #444;
  }
  body {
    max-width: 900px; margin: auto; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg-color-light);
    color: var(--text-color-light);
    transition: background-color 0.3s, color 0.3s;
    padding: 1rem;
  }
  body.dark {
    background-color: var(--bg-color-dark);
    color: var(--text-color-dark);
  }
  header {
    margin: 20px 0; display: flex; justify-content: space-between; align-items: center;
  }
  nav button, nav #toggle-theme {
    margin-left: 10px;
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  nav button:hover, nav #toggle-theme:hover {
    background: #0059c1;
  }

  /* 검색창 스타일 */
  #search-bar {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  #search-input {
    flex-grow: 1;
    padding: 10px 14px;
    border-radius: 12px;
    border: 1.5px solid var(--border-color-light);
    transition: border-color 0.3s;
    font-size: 1rem;
  }
  #search-input:focus {
    border-color: var(--primary-color);
    outline: none;
  }
  #search-button {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
  }
  #search-button:hover {
    background: #0059c1;
  }

  #posts {
    margin-top: 20px;
  }
  .post {
    border: 1.5px solid var(--border-color-light);
    padding: 18px 22px;
    margin-bottom: 16px;
    border-radius: 14px;
    background: white;
    transition: background-color 0.3s, border-color 0.3s;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
  }
  body.dark .post {
    background: #222;
    border-color: var(--border-color-dark);
    box-shadow: 0 3px 8px rgb(255 255 255 / 0.1);
  }
  .post h3 {
    margin: 0 0 8px 0;
    font-size: 1.25rem;
  }
  .post h3 a {
    color: var(--primary-color);
    text-decoration: none;
  }
  .post h3 a:hover {
    text-decoration: underline;
  }
  #post-detail {
    display: none;
    border: 1.5px solid var(--border-color-light);
    padding: 24px 30px;
    margin-top: 20px;
    border-radius: 14px;
    background: white;
    transition: background-color 0.3s, border-color 0.3s;
    box-shadow: 0 3px 12px rgb(0 0 0 / 0.15);
  }
  body.dark #post-detail {
    background: #222;
    border-color: var(--border-color-dark);
    box-shadow: 0 3px 12px rgb(255 255 255 / 0.15);
  }
  #post-detail img {
    max-width: 100%;
    height: auto;
    margin: 12px 0;
    border-radius: 10px;
  }
  #comments > div {
    border-top: 1px solid var(--border-color-light);
    padding: 10px 0;
    font-size: 0.95rem;
  }
  body.dark #comments > div {
    border-color: var(--border-color-dark);
  }
  form {
    margin-top: 20px;
  }
  textarea {
    width: 100%;
    height: 90px;
    padding: 12px;
    border-radius: 14px;
    border: 1.5px solid var(--border-color-light);
    resize: vertical;
    background: white;
    color: inherit;
    font-size: 1rem;
    transition: background-color 0.3s, border-color 0.3s;
  }
  body.dark textarea {
    background: #333;
    border-color: var(--border-color-dark);
  }
  input[type=text], input[type=password] {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 14px;
    border: 1.5px solid var(--border-color-light);
    background: white;
    color: inherit;
    font-size: 1rem;
    transition: background-color 0.3s, border-color 0.3s;
  }
  body.dark input[type=text], body.dark input[type=password] {
    background: #333;
    border-color: var(--border-color-dark);
  }
  button[type=submit], #btn-new-post, #btn-back {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 10px 22px;
    border-radius: 14px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    margin-top: 14px;
    box-shadow: 0 3px 6px rgb(41 121 255 / 0.5);
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  button[type=submit]:hover, #btn-new-post:hover, #btn-back:hover {
    background: #0059c1;
    box-shadow: 0 5px 12px rgb(0 89 193 / 0.7);
  }

  /* 모달 스타일 */
  #modal-overlay {
    display:none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
  }
  #modal {
    display:none;
    position: fixed;
    top: 15%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 36px 30px 24px;
    box-shadow: 0 0 25px rgba(0,0,0,0.4);
    border-radius: 18px;
    width: 360px;
    max-width: 90%;
    z-index: 1000;
    color: inherit;
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark #modal {
    background: #222;
    color: var(--text-color-dark);
  }
  #modal h3 {
    margin: 0 0 18px;
    font-size: 1.5rem;
    text-align: center;
  }
  #modal input[type=text], #modal input[type=password] {
    margin-bottom: 16px;
    font-size: 1rem;
  }
  #modal button {
    width: 100%;
    padding: 12px 0;
    border-radius: 14px;
    font-size: 1.1rem;
    font-weight: 700;
    box-shadow: 0 4px 10px rgb(41 121 255 / 0.6);
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  #modal button:hover {
    background: #0059c1;
    box-shadow: 0 6px 14px rgb(0 89 193 / 0.8);
  }
  #modal-message {
    color: #d33;
    margin-top: 12px;
    font-size: 1rem;
    text-align: center;
    min-height: 1.2em;
  }
  #modal .switch-to-register {
    margin-top: 22px;
    text-align: center;
    font-size: 1rem;
    color: var(--primary-color);
    cursor: pointer;
    user-select: none;
  }
  #modal .switch-to-register:hover {
    text-decoration: underline;
  }
  /* 닫기 버튼 스타일 */
  #modal-close {
    position: absolute;
    top: 12px;
    right: 16px;
    font-size: 24px;
    color: var(--primary-color);
    cursor: pointer;
    font-weight: 700;
    user-select: none;
    transition: color 0.3s;
  }
  #modal-close:hover {
    color: #0059c1;
  }
</style>
</head>
<body>

<header>
  <h1>게임 게시판</h1>
  <nav>
    <span id="user-info"></span>
    <button id="btn-login">로그인</button>
    <button id="btn-logout" style="display:none;">로그아웃</button>
    <button id="toggle-theme" title="다크모드/라이트모드 전환">🌓</button>
  </nav>
</header>

<section id="main-section">

  <!-- 검색 UI -->
  <div id="search-bar">
    <input type="text" id="search-input" placeholder="제목, 내용, 닉네임 검색" />
    <button id="search-button">검색</button>
  </div>

  <div id="posts"></div>
  <button id="btn-new-post" style="display:none;">새 글 작성</button>
</section>

<section id="post-detail">
  <button id="btn-back">목록으로</button>
  <h2 id="detail-title"></h2>
  <p id="detail-author"></p>
  <p id="detail-category"></p>
  <img id="detail-image" alt="" style="display:none;" />
  <p id="detail-content"></p>
  <div id="comments"></div>

  <form id="comment-form" style="display:none;">
    <textarea id="comment-content" placeholder="댓글 작성"></textarea>
    <button type="submit">댓글 달기</button>
  </form>
</section>

<div id="modal-overlay"></div>

<div id="modal">
  <div id="modal-close" title="닫기">×</div>
  <h3 id="modal-title"></h3>
  <form id="modal-form">
    <input type="text" id="modal-username" placeholder="아이디" required autocomplete="username" />
    <input type="password" id="modal-password" placeholder="비밀번호" required autocomplete="current-password" />
    <input type="text" id="modal-nickname" placeholder="닉네임" style="display:none;" required autocomplete="nickname" />
    <button type="submit">제출</button>
  </form>
  <p id="modal-message"></p>
  <div class="switch-to-register" id="switch-register">계정이 없으신가요? 회원가입</div>
</div>

<script>
const apiBase = '/api';

let token = localStorage.getItem('token');
let currentUser = null;
let currentPostId = null;

function setToken(t) {
  token = t;
  if (t) localStorage.setItem('token', t);
  else localStorage.removeItem('token');
  updateUserInfo();
}

function updateUserInfo() {
  if (token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      currentUser = payload.nickname;
      document.getElementById('user-info').textContent = currentUser + ' 님 환영합니다';
      document.getElementById('btn-login').style.display = 'none';
      document.getElementById('btn-logout').style.display = 'inline-block';
      document.getElementById('btn-new-post').style.display = 'inline-block';
    } catch {
      setToken(null);
    }
  } else {
    currentUser = null;
    document.getElementById('user-info').textContent = '';
    document.getElementById('btn-login').style.display = 'inline-block';
    document.getElementById('btn-logout').style.display = 'none';
    document.getElementById('btn-new-post').style.display = 'none';
  }
}

async function apiFetch(url, options = {}) {
  options.headers = options.headers || {};
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  const res = await fetch(apiBase + url, options);
  if (res.status === 401) {
    alert('인증이 필요합니다. 로그인 해주세요.');
    logout();
    throw new Error('Unauthorized');
  }
  return res.json();
}

async function loadPosts(searchTerm = '') {
  const query = searchTerm ? `?search=${encodeURIComponent(searchTerm)}` : '';
  const posts = await apiFetch('/posts' + query);
  const postsDiv = document.getElementById('posts');
  postsDiv.innerHTML = '';
  if(posts.length === 0){
    postsDiv.innerHTML = '<p>검색 결과가 없습니다.</p>';
    return;
  }
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<h3><a href="#" data-id="${p.id}">${p.title}</a></h3>
                     <p>작성자: ${p.nickname} | 조회수: ${p.views} | 카테고리: ${p.category || '없음'}</p>`;
    postsDiv.appendChild(div);
  });

  document.querySelectorAll('.post a').forEach(el => {
    el.onclick = e => {
      e.preventDefault();
      showPostDetail(e.target.dataset.id);
    };
  });
}

async function showPostDetail(id) {
  const data = await apiFetch('/posts/' + id);
  currentPostId = id;
  document.getElementById('main-section').style.display = 'none';
  const detail = document.getElementById('post-detail');
  detail.style.display = 'block';
  document.getElementById('detail-title').textContent = data.post.title;
  document.getElementById('detail-author').textContent = '작성자: ' + data.post.nickname;
  document.getElementById('detail-category').textContent = '카테고리: ' + (data.post.category || '없음');
  if (data.post.image_url) {
    const img = document.getElementById('detail-image');
    img.src = data.post.image_url;
    img.style.display = 'block';
  } else {
    document.getElementById('detail-image').style.display = 'none';
  }
  document.getElementById('detail-content').textContent = data.post.content;

  const commentsDiv = document.getElementById('comments');
  commentsDiv.innerHTML = '<h4>댓글</h4>';
  data.comments.forEach(c => {
    const cdiv = document.createElement('div');
    cdiv.textContent = c.nickname + ': ' + c.content;
    commentsDiv.appendChild(cdiv);
  });

  if (token) {
    document.getElementById('comment-form').style.display = 'block';
  } else {
    document.getElementById('comment-form').style.display = 'none';
  }
}

document.getElementById('comment-form').onsubmit = async e => {
  e.preventDefault();
  const content = document.getElementById('comment-content').value.trim();
  if (!content) return alert('댓글 내용을 입력하세요.');
  await apiFetch('/comments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ post_id: currentPostId, content })
  });
  document.getElementById('comment-content').value = '';
  showPostDetail(currentPostId);
};

document.getElementById('btn-back').onclick = () => {
  currentPostId = null;
  document.getElementById('post-detail').style.display = 'none';
  document.getElementById('main-section').style.display = 'block';
  loadPosts();
};

const modal = document.getElementById('modal');
const modalOverlay = document.getElementById('modal-overlay');
const modalForm = document.getElementById('modal-form');
const modalTitle = document.getElementById('modal-title');
const modalUsername = document.getElementById('modal-username');
const modalPassword = document.getElementById('modal-password');
const modalNickname = document.getElementById('modal-nickname');
const modalMessage = document.getElementById('modal-message');
const modalCloseBtn = document.getElementById('modal-close');

let modalMode = 'login';

document.getElementById('btn-login').onclick = () => openModal('login');
document.getElementById('btn-logout').onclick = () => {
  setToken(null);
  alert('로그아웃 되었습니다.');
  loadPosts();
};

document.getElementById('switch-register').onclick = () => openModal('register');
modalCloseBtn.onclick = closeModal;
modalOverlay.onclick = closeModal;

function openModal(mode) {
  modalMode = mode;
  modal.style.display = 'block';
  modalOverlay.style.display = 'block';
  modalTitle.textContent = mode === 'login' ? '로그인' : '회원가입';
  modalMessage.textContent = '';
  modalUsername.value = '';
  modalPassword.value = '';
  if (mode === 'register') {
    modalNickname.style.display = 'block';
    modalNickname.value = '';
  } else {
    modalNickname.style.display = 'none';
  }
}

function closeModal() {
  modal.style.display = 'none';
  modalOverlay.style.display = 'none';
}

modalForm.onsubmit = async e => {
  e.preventDefault();
  const username = modalUsername.value.trim();
  const password = modalPassword.value.trim();
  const nickname = modalNickname.value.trim();

  if (!username || !password || (modalMode === 'register' && !nickname)) {
    modalMessage.textContent = '필드를 모두 입력하세요.';
    return;
  }

  try {
    if (modalMode === 'login') {
      const res = await fetch(apiBase + '/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (res.ok) {
        setToken(data.token);
        closeModal();
        loadPosts();
      } else {
        modalMessage.textContent = data.message;
      }
    } else {
      const res = await fetch(apiBase + '/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password, nickname })
      });
      const data = await res.json();
      if (res.ok) {
        alert('회원가입 성공! 로그인 해주세요.');
        openModal('login');
      } else {
        modalMessage.textContent = data.message;
      }
    }
  } catch {
    modalMessage.textContent = '서버 오류가 발생했습니다.';
  }
};

// 다크모드 토글
const themeToggleBtn = document.getElementById('toggle-theme');
function loadTheme() {
  const saved = localStorage.getItem('theme');
  if(saved === 'dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
}
function toggleTheme() {
  document.body.classList.toggle('dark');
  if(document.body.classList.contains('dark')) localStorage.setItem('theme', 'dark');
  else localStorage.setItem('theme', 'light');
}
themeToggleBtn.onclick = toggleTheme;
loadTheme();

// 검색 기능
const searchInput = document.getElementById('search-input');
const searchButton = document.getElementById('search-button');

searchButton.onclick = () => {
  const keyword = searchInput.value.trim();
  loadPosts(keyword);
};

searchInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchButton.click();
  }
});

updateUserInfo();
loadPosts();
</script>
</body>
</html>
